<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“¡å·¥è©•åˆ†ç³»çµ±</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">

    <!-- æ•´åˆ CSS æ¨£å¼ -->
     
    
 
</head>
<body>
    <div id="customMessageBox" class="custom-message-box"></div>
    
    <div class="container">
        
        <div class="flex items-center justify-center mb-6">
            <!-- æ›¿æ› HongYipLogo.png ç‚º Tailwind æ¨£å¼çš„ä½”ä½ç¬¦ -->
                        <img src="HongYipLogo.png" alt="logo" class="w-16 h-16 mr-4 object-contain">

            <h1 class="text-3xl font-bold" style="color: #004d99;">å“¡å·¥è©•åˆ†ç³»çµ±</h1>
        </div>
        <div class="evaluator-info flex justify-between items-center mb-5 p-3 bg-white rounded-lg shadow-md border border-gray-100">
            <span class="text-lg">ç•¶å‰è©•æ ¸äººï¼š<span id="currentEvaluatorDisplay" class="font-semibold text-[#ff6b35]"></span></span>
            <div class="flex space-x-3">
               
                <button onclick="logout()" class="logout-button bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-150 shadow-md">ç™»å‡º</button>
            </div>
        </div>
        
        <div id="employeeList">
            <div class="employee-grid" id="employeeGrid">
                <div class="loading ">è¼‰å…¥å“¡å·¥è³‡æ–™ä¸­...</div>
                
            </div>
        </div>

        
        
        <div id="employeeDetail" style="display: none;">
            <button class="back-button bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg mb-5 transition duration-150 shadow-md" onclick="showEmployeeList()">â† è¿”å›å“¡å·¥åˆ—è¡¨</button>
            <div id="basicContent"></div>
        </div>
    </div>

    <script>
    // google sheet config
    const SPREADSHEET_ID = '1znQ2MapAc4fqXJc3SDxoixbrd-b6Xry4auf8vFIcqDc';
    const API_KEY = 'AIzaSyDj2ktQ36AoBSrYxPj_R4USvzvLtfh8Kb0'; 
    const scriptURL = 'https://script.google.com/macros/s/AKfycby46B_BO5E6cbIxYUngBCcT1Las-zSElgx6k1Kf057WH5_T0xrVQvm1IpmEhAtT47jl/exec';
    
    
    const SHEETS = {
        BASIC: 'å“¡å·¥è³‡æ–™',
        EDUCATION: 'å­¸æ­·ï¼å°ˆæ¥­è³‡æ ¼',
        EXPERIENCE: 'å·¥ä½œç¶“é©—',
        EMPLOYMENT: 'åº·æ¥­å—åƒ±è¨˜éŒ„',
        RATING: 'è€ƒå¯Ÿåœ˜è©•åˆ†é¸é …',
        INTERVIEW_RATING: 'æœƒé¢è©•åˆ†é¸é …',
        EVALUATORS: 'è©•æ ¸äººåå–®',
        TOUR_SCORE: 'è€ƒå¯Ÿåœ˜æ•´é«”è©•åˆ†', 
        INTERVIEW_SCORE: 'æœƒé¢è©•åˆ†'
    };

    let evaluatorList = [];
    let currentEvaluator = null;
    let allEmployees = [];
    let educationData = [];
    let experienceData = [];
    let employmentData = [];
    let ratingOptions = [];
    let interviewRatingOptions = []; 
    let currentEmployee = null;
    let employeeScores = {}; // NEW: å„²å­˜è©•æ ¸äººå°æ‰€æœ‰å“¡å·¥çš„æœ€æ–°è©•åˆ†

    // --- è‡ªå®šç¾©è¨Šæ¯å’Œè¼‰å…¥ç‹€æ…‹å‡½æ•¸ ---
    function showCustomMessage(message, type = 'info') {
        const msgBox = document.getElementById('customMessageBox');
        msgBox.textContent = message;
        msgBox.className = `custom-message-box show ${type}`;
        
        setTimeout(() => {
            msgBox.classList.remove('show');
        }, 3000);
    }

    function showLoading() { 
        document.getElementById('employeeGrid').innerHTML = '<div class="loading text-center text-xl p-10 text-gray-500">è¼‰å…¥ä¸­...</div>'; 
    }
    
    function hideLoading() { 
        // intentionally empty to allow the next displayEmployees call to hide it
    }
    
    function showError(message) { 
        document.getElementById('employeeGrid').innerHTML = `<div class="error text-center text-red-600 p-10 border border-red-300 bg-red-50 rounded-lg">${message}</div>`; 
    }

    // check login
    document.addEventListener('DOMContentLoaded', function() {
        const savedEvaluator = localStorage.getItem("currentEvaluator");
        
        if (!savedEvaluator) {
            
            window.location.href = "login.html";
            return;
        }
        
        // è¨­ç½®ç•¶å‰è©•æ ¸äºº
        currentEvaluator = savedEvaluator;
        document.getElementById("currentEvaluatorDisplay").textContent = currentEvaluator;
        
        // è¼‰å…¥ç³»çµ±è³‡æ–™
        loadAllData();
    });

    // upload data from google sheet
    async function loadSheetData(sheetName) {
        // Since we are using an App Script for evaluation data, the Sheets API for basic employee data is fine.
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(sheetName)}?key=${API_KEY}`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            if (!data.values) return [];
            const headers = data.values[0];
            const rows = data.values.slice(1);
            return rows.map(row => {
                const obj = {};
                headers.forEach((header, index) => obj[header] = row[index] || '');
                return obj;
            });
        } catch (error) {
            console.error(`åŠ è¼‰ ${sheetName} å¤±æ•—:`, error);
            return [];
        }
    }
    
    // NEW FUNCTION: è¼‰å…¥ç•¶å‰è©•æ ¸äººå°æ‰€æœ‰å“¡å·¥çš„æœ€æ–°è©•åˆ†
    async function loadAllEvaluatorRatings(evaluator) {
        if (!evaluator) return [];
        const url = `${scriptURL}?action=getAllEvaluatorRatings&evaluator=${encodeURIComponent(evaluator)}`;
        try {
            const response = await fetch(url);
            const result = await response.json();
            if (result.success) {
                console.log('æ‰€æœ‰è©•åˆ†è¼‰å…¥æˆåŠŸ:', result.data);
                return result.data;
            } else {
                console.error("è¼‰å…¥æ‰€æœ‰è©•åˆ†å¤±æ•—:", result.message);
                return [];
            }
        } catch (error) {
            console.error("è¼‰å…¥æ‰€æœ‰è©•åˆ†å¤±æ•—:", error);
            return [];
        }
    }

    // upload all data
    async function loadAllData() {
        showLoading();
        // ä½¿ç”¨ Promise.all åŠ é€Ÿæ•¸æ“šè¼‰å…¥
        const [basic, education, experience, employment, ratings, interviewRatings, evaluators, allRatings] = await Promise.all([
            loadSheetData(SHEETS.BASIC),
            loadSheetData(SHEETS.EDUCATION),
            loadSheetData(SHEETS.EXPERIENCE),
            loadSheetData(SHEETS.EMPLOYMENT),
            loadSheetData(SHEETS.RATING),
            loadSheetData(SHEETS.INTERVIEW_RATING),
            loadSheetData(SHEETS.EVALUATORS),
            loadAllEvaluatorRatings(currentEvaluator) // <-- NEW: Fetch all scores
        ]);

        allEmployees = basic;
        educationData = education;
        experienceData = experience;
        experienceData = experience.map(record => ({
            ...record,
            // ç¢ºä¿ã€Œå…¥è·å‰ç¸½å¹´è³‡ã€å­—æ®µå­˜åœ¨ï¼Œå³ä½¿ç‚ºç©ºï¼Œé¿å…æ¨¡æ¿æ¸²æŸ“å•é¡Œ
            'å…¥è·å‰ç¸½å¹´è³‡': record['å…¥è·å‰ç¸½å¹´è³‡'] || '' 
        }));
        employmentData = employment;
        evaluatorList = evaluators.map(e => e.è©•æ ¸äººå§“å || e.è©•æ ¸äºº);

        // è€ƒå¯Ÿåœ˜è©•åˆ†é¸é …
        ratingOptions = ratings.map(row => ({
            'è©•åˆ†é …ç›®': row['è©•åˆ†é …ç›®'] || 'æœªå‘½å',
            'æœ€ä½åˆ†': parseInt(row['æœ€ä½åˆ†']) || 0,
            'æœ€é«˜åˆ†': parseInt(row['æœ€é«˜åˆ†']) || 5
        }));

        // æœƒé¢è©•åˆ†é¸é …
        interviewRatingOptions = interviewRatings.map(row => ({
            'è©•åˆ†é …ç›®': row['è©•åˆ†é …ç›®'] || 'æœªå‘½å',
            'æœ€ä½åˆ†': parseInt(row['æœ€ä½åˆ†']) || 0,
            'æœ€é«˜åˆ†': parseInt(row['æœ€é«˜åˆ†']) || 5
        }));

        // è™•ç†æ‰€æœ‰è©•åˆ†æ•¸æ“šï¼Œè½‰ç‚ºä»¥å“¡å·¥ç·¨è™Ÿç‚ºéµçš„æ˜ å°„
        employeeScores = allRatings.reduce((acc, score) => {
            acc[score.å“¡å·¥ç·¨è™Ÿ] = score;
            return acc;
        }, {});


        displayEmployees(allEmployees);
        hideLoading();
    }

    // employee list (UPDATED)
    function displayEmployees(employees) {
        const grid = document.getElementById('employeeGrid');
        if (employees.length === 0) {
            grid.innerHTML = '<div class="error">æ‰¾ä¸åˆ°å“¡å·¥è³‡æ–™</div>';
            return;
        }
        grid.innerHTML = employees.map(emp => {
            const scores = employeeScores[emp.å“¡å·¥ç·¨è™Ÿ] || {};
            
            // æª¢æŸ¥åˆ†æ•¸æ˜¯å¦å­˜åœ¨
            const tourTotal = scores.tourTotal !== null && scores.tourTotal !== undefined ? scores.tourTotal : null;
            const interviewTotal = scores.interviewTotal !== null && scores.interviewTotal !== undefined ? scores.interviewTotal : null;

            // æ ¼å¼åŒ–é¡¯ç¤º
            const tourScoreDisplay = tourTotal !== null 
                ? `<span class="text-green-600 font-bold">${tourTotal} åˆ†</span> <span class="text-xs text-gray-400">(${scores.tourDate ? scores.tourDate.substring(0, 10) : 'N/A'})</span>` 
                : '<span class="text-red-500">æœªè©•åˆ†</span>';
            const interviewScoreDisplay = interviewTotal !== null 
                ? `<span class="text-blue-600 font-bold">${interviewTotal} åˆ†</span> <span class="text-xs text-gray-400">(${scores.interviewDate ? scores.interviewDate.substring(0, 10) : 'N/A'})</span>` 
                : '<span class="text-red-500">æœªè©•åˆ†</span>';

            return `
                <div class="employee-card" onclick="showEmployeeDetail('${emp.å“¡å·¥ç·¨è™Ÿ}')">
                    <h3 class="text-xl font-bold text-[#004d99] mb-2">${emp.å“¡å·¥å§“å || 'ç„¡å§“å'} (${emp.å“¡å·¥ç·¨è™Ÿ || 'ç„¡ç·¨è™Ÿ'})</h3>
                    <div class="employee-info text-sm text-gray-700">
                        <p><strong>éƒ¨é–€ï¼š</strong>${emp.éƒ¨é–€ || 'æœªå¡«å¯«'}</p>
                        <p><strong>è·ä½ï¼š</strong>${emp.è·ä½ || 'æœªå¡«å¯«'}</p>
                    </div>
                    <div class="rating-summary mt-3 pt-3 border-t border-gray-200">
                        <div class="flex justify-between items-center text-sm mb-1">
                            <span class="font-medium text-gray-500">è€ƒå¯Ÿåœ˜è©•åˆ†:</span>
                            ${tourScoreDisplay}
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="font-medium text-gray-500">æœƒé¢è©•åˆ†:</span>
                            ${interviewScoreDisplay}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // employee info. (UPDATED to include Employee Photo)
    function showEmployeeDetail(employeeId) {
    currentEmployee = allEmployees.find(emp => emp.å“¡å·¥ç·¨è™Ÿ === employeeId);
    if (!currentEmployee) return;

    document.getElementById('employeeList').style.display = 'none';
    document.getElementById('employeeDetail').style.display = 'block';
    
    displayAllInfo(); // å‘¼å«æ›´æ–°å¾Œçš„é¡¯ç¤ºå‡½å¼

    updateTotalScore(ratingOptions, 'rating');
    updateTotalScore(interviewRatingOptions, 'interview');
    
    // ç¢ºä¿é€™è£¡æœ‰å®šç¾© loadHistoryRatings å‡½å¼ä¸¦æ­£ç¢ºä½¿ç”¨
     loadHistoryRatings(employeeId, currentEvaluator); 
}

function displayAllInfo() {
    const content = document.getElementById('basicContent');
    const employee = currentEmployee;

    const educationRecords = educationData.filter(edu => edu.å“¡å·¥ç·¨è™Ÿ === employee.å“¡å·¥ç·¨è™Ÿ);
    const experienceRecords = experienceData.filter(exp => exp.å“¡å·¥ç·¨è™Ÿ === employee.å“¡å·¥ç·¨è™Ÿ);
    const employmentRecords = employmentData.filter(emp => emp.å“¡å·¥ç·¨è™Ÿ === employee.å“¡å·¥ç·¨è™Ÿ);

    // æª¢æŸ¥å“¡å·¥ç…§ç‰‡å­—æ®µä¸¦ç”Ÿæˆ HTML
    const employeePhotoUrl = employee.å“¡å·¥ç…§ç‰‡ && employee.å“¡å·¥ç…§ç‰‡.startsWith('http') ? employee.å“¡å·¥ç…§ç‰‡ : null;
    
    // **ç›´é•·æ–¹å½¢ç…§ç‰‡ (Vertical Rectangle - ID Photo Style) æ¨£å¼**
    // ä½¿ç”¨ w-32 h-48 (128px x 192px) å»ºç«‹ç›´ç«‹é•·æ–¹å½¢æ¯”ä¾‹
    const photoPlaceholderUrl = `https://placehold.co/128x192/004d99/ffffff?text=${(employee.å“¡å·¥å§“å || 'ç„¡').substring(0, 1)}%20(ç„¡ç…§ç‰‡)`;
    
    console.log(`å“¡å·¥ ${employee.å“¡å·¥å§“å} çš„ç…§ç‰‡ URL (è¨ºæ–·):`, employeePhotoUrl);

    // ä½¿ç”¨ w-32 h-48, rounded-lg (ç›´é•·æ–¹å½¢)ï¼Œä¸¦æ·»åŠ  shadow-xl å¢åŠ ç«‹é«”æ„Ÿ
    const employeePhotoHtml = employeePhotoUrl 
        ? `<img src="${employeePhotoUrl}" alt="${employee.å“¡å·¥å§“å} - å“¡å·¥ç…§ç‰‡" class="w-32 h-48 object-cover rounded-lg shadow-xl mb-4 bg-gray-200" onerror="this.onerror=null; this.src='${photoPlaceholderUrl}';">` 
        : `<div class="w-32 h-48 flex items-center justify-center bg-gray-200 rounded-lg text-gray-500 shadow-xl text-3xl font-semibold mb-4">${(employee.å“¡å·¥å§“å || 'ç„¡').substring(0, 2)}</div>`;


    content.innerHTML = `
        <div class="detail-section">
            <h3>ğŸ‘¤ åŸºæœ¬è³‡æ–™ - ${employee.å“¡å·¥å§“å}</h3>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- å“¡å·¥ç…§ç‰‡æ¬„ä½ (å·¦å´) - å¢åŠ  flex flex-col items-center è®“å›ºå®šå°ºå¯¸çš„ç›´é•·æ–¹å½¢ç…§ç‰‡å±…ä¸­ -->
                <div class="lg:col-span-1 flex flex-col items-center">
                    ${employeePhotoHtml}
                    
                </div>
                <!-- åŸºæœ¬è³‡æ–™ (å³å´) -->
                <div class="lg:col-span-2">
                    <div class="detail-item grid grid-cols-1 md:grid-cols-2 gap-4">
                        <p><strong>å“¡å·¥ç·¨è™Ÿï¼š</strong>${employee.å“¡å·¥ç·¨è™Ÿ || 'æœªå¡«å¯«'}</p>
                        <p><strong>å¹´é½¡ï¼š</strong>${employee.å¹´é½¡ || 'æœªå¡«å¯«'}</p>
                        <p><strong>å©šå§»ç‹€æ³ï¼š</strong>${employee.å©šå§»ç‹€æ³ || 'æœªå¡«å¯«'}</p>
                        <p><strong>å­å¥³æ•¸ç›®ï¼š</strong>${employee.å­å¥³æ•¸ç›® || '0'}</p>
                        <p><strong>è·ä½ï¼š</strong>${employee.è·ä½ || 'æœªå¡«å¯«'}</p>
                        <p><strong>åœ°åŸŸï¼š</strong>${employee.åœ°åŸŸ || 'æœªå¡«å¯«'}</p>
                        <p><strong>éƒ¨é–€/åˆ†å€ï¼š</strong>${employee.éƒ¨é–€ || 'æœªå¡«å¯«'}</p>
                        <p><strong>åˆ°è·æ—¥æœŸï¼š</strong>${employee.åˆ°è·æ—¥æœŸ || 'æœªå¡«å¯«'}</p>
                        <p><strong>ç¸¾æ•ˆè©•ä¼°ç­‰ç´š2023ï¼š</strong>${employee.ç¸¾æ•ˆè©•ä¼°ç­‰ç´š2023 || 'æœªå¡«å¯«'}</p>
                        <p><strong>ç¸¾æ•ˆè©•ä¼°ç­‰ç´š2024ï¼š</strong>${employee.ç¸¾æ•ˆè©•ä¼°ç­‰ç´š2024 || 'æœªå¡«å¯«'}</p>
                    </div>
                </div>
            </div>
        </div>

            <div class="detail-section">
                <h3>ğŸ“ å­¸æ­·ï¼å°ˆæ¥­è³‡æ ¼</h3>
                ${educationRecords.length > 0 ? educationRecords.map(record => `
                    <div class="education-record border-b pb-2 mb-2">
                        <p><strong>æœŸé–“ï¼š</strong>${record.ç”± || ''} - ${record.è‡³ || ''}</p>
                        <p><strong>å­¸é™¢åç¨±ï¼š</strong>${record.å­¸é™¢åç¨± || ''}</p>
                        <p><strong>æ‰€ç²è­‰æ›¸/è³‡æ ¼ï¼š</strong>${record.æ‰€ç²è­‰æ›¸è³‡æ ¼ || ''}</p>
                    </div>
                `).join('') : '<div class="no-data">æ²’æœ‰å­¸æ­·è³‡æ ¼è¨˜éŒ„</div>'}
            </div>

            <div class="detail-section">
                <h3>ğŸ¢ å·¥ä½œç¶“é©—</h3>
                ${experienceRecords.length > 0 ? experienceRecords.map(record => `
                    <div class="experience-record border-b pb-2 mb-2">
                        <p><strong>æœŸé–“ï¼š</strong>${record.ç”± || ''} - ${record.è‡³ || ''}</p>
                        <p><strong>å…¬å¸åç¨±ï¼š</strong>${record.å…¬å¸åç¨± || ''}</p>
                        <p><strong>é›¢è·æ™‚è·ä½ï¼š</strong>${record.é›¢è·æ™‚è·ä½ || ''}</p>
                        <p><strong>å…¥è·å‰ç¸½å¹´è³‡ï¼š</strong>${record.å…¥è·å‰ç¸½å¹´è³‡ || ''}</p>
                    </div>
                `).join('') : '<div class="no-data">æ²’æœ‰å·¥ä½œç¶“é©—è¨˜éŒ„</div>'}
            </div>

            <div class="detail-section">
                <h3>ğŸ“‹ åº·æ¥­å—åƒ±è¨˜éŒ„</h3>
                ${employmentRecords.length > 0 ? employmentRecords.map(record => `
                    <div class="employment-record border-b pb-2 mb-2">
                        <p><strong>æœŸé–“ï¼š</strong>${record.ç”± || ''} - ${record.è‡³ || ''}</p>
                        <p><strong>åˆ†å€ï¼š</strong>${record.åˆ†å€ || ''}</p>
                        <p><strong>å¤§å»ˆï¼š</strong>${record.å¤§å»ˆ || ''}</p>
                        <p><strong>è·ä½ï¼š</strong>${record.è·ä½ || ''}</p>
                        <p><strong>å¹´è³‡ï¼š</strong>${record.å¹´è³‡ || ''}</p>
                    </div>
                `).join('') : '<div class="no-data">æ²’æœ‰å—åƒ±è¨˜éŒ„</div>'}
            </div>

            <!-- æ­·å²è©•åˆ†è¨˜éŒ„å€å¡Š -->
            <div class="detail-section mt-8">
                <h3>ğŸ“œ ä½ çš„è©•åˆ†è¨˜éŒ„ (${currentEvaluator} çš„è©•åˆ†)</h3>
                <div id="historyRatingsContainer">æ­£åœ¨è¼‰å…¥æ‚¨çš„æ­·å²è¨˜éŒ„...</div>
            </div>
            
            <!-- è€ƒå¯Ÿåœ˜è©•åˆ†è¡¨å–® -->
            <div class="evaluation-form">
                <h3>ğŸ“ è€ƒå¯Ÿåœ˜æ•´é«”è©•åˆ†</h3>
                <div class="evaluator-display">è©•æ ¸äººï¼š${currentEvaluator}</div>
                <div id="ratingItemsContainer">${generateRatingItems(ratingOptions, 'rating')}</div>
                <div class="score-breakdown" id="ratingScoreBreakdown">${generateScoreBreakdown(ratingOptions, 'rating')}</div>
                <div class="total-score" id="ratingTotalScore">ç¸½åˆ†: 0 / ${calculateMaxScore(ratingOptions)}</div>
                <button class="submit-button" onclick="submitEvaluation('${SHEETS.TOUR_SCORE}', ratingOptions, 'rating')">æäº¤è€ƒå¯Ÿåœ˜è©•åˆ†</button>
            </div>

            <!-- æœƒé¢è©•åˆ†è¡¨å–® -->
            <div class="interview-form">
                <h3>ğŸ“ æœƒé¢è©•åˆ†</h3>
                <div class="evaluator-display">è©•æ ¸äººï¼š${currentEvaluator}</div>
                <div id="interviewRatingItemsContainer">${generateRatingItems(interviewRatingOptions, 'interview')}</div>
                <div class="score-breakdown" id="interviewScoreBreakdown">${generateScoreBreakdown(interviewRatingOptions, 'interview')}</div>
                <div class="total-score" id="interviewTotalScore">ç¸½åˆ†: 0 / ${calculateMaxScore(interviewRatingOptions)}</div>
                <button class="submit-button" onclick="submitEvaluation('${SHEETS.INTERVIEW_SCORE}', interviewRatingOptions, 'interview')">æäº¤æœƒé¢è©•åˆ†</button>
            </div>
            
            
        `;

        // ç¶å®šè©•åˆ†æ»‘æ¡¿äº‹ä»¶
        setupRatingSliders(ratingOptions, 'rating');
        setupRatingSliders(interviewRatingOptions, 'interview');
    }

    
    // history
async function loadHistoryRatings(employeeId, evaluator) {
    const container = document.getElementById('historyRatingsContainer');
    if (!container) {
        console.error('æ‰¾ä¸åˆ°æ­·å²è¨˜éŒ„å®¹å™¨');
        return;
    }
    
    container.innerHTML = '<div class="no-data text-center p-5 text-blue-500">æ­£åœ¨è¼‰å…¥æ­·å²è©•åˆ†...</div>';

    try {
        const url = `${scriptURL}?action=getRatings&employeeId=${encodeURIComponent(employeeId)}&evaluator=${encodeURIComponent(evaluator)}`;
        
        console.log(url);
        
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹: ${response.status}`);
        }
        
        const result = await response.json(); 

        if (!result.success) {
            container.innerHTML = `<div class="no-data text-center p-5 border border-yellow-400 bg-yellow-50">è¼‰å…¥æ­·å²å¤±æ•—: ${result.message}</div>`;
            return;
        }

        const allHistory = result.data;
        
        if (!allHistory || (allHistory.tour.length === 0 && allHistory.interview.length === 0)) {
            container.innerHTML = '<div class="no-data text-center p-5 bg-gray-50 rounded-lg">ç„¡ç›¸é—œæ­·å²è©•åˆ†è¨˜éŒ„ã€‚</div>';
            return;
        }

        
        container.innerHTML = `
            ${renderHistorySection(allHistory.tour, 'è€ƒå¯Ÿåœ˜è©•åˆ†ç´€éŒ„', '#004d99', 'tour')}
            ${renderHistorySection(allHistory.interview, 'æœƒé¢è©•åˆ†ç´€éŒ„', '#004d99', 'interview')}
        `;
        
    } catch (error) {
        console.error("è¼‰å…¥æ­·å²è©•åˆ†å¤±æ•—:", error);
        container.innerHTML = `
            <div class="no-data text-center p-5 border border-red-400 bg-red-100 text-red-700 rounded-lg">
                ç„¡æ³•è¼‰å…¥æ­·å²è¨˜éŒ„<br>
                <small>éŒ¯èª¤: ${error.message}</small>
                <br><br>
                <button onclick="loadHistoryRatings('${employeeId}', '${evaluator}')" 
                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded mt-2">
                    é‡æ–°è¼‰å…¥
                </button>
            </div>
        `;
    }
}

function renderHistorySection(records, title, color, type) {
    if (records.length === 0) {
        return `
            <div class="mb-6 p-4 border-l-4" style="border-left-color: ${color};">
                <h4 class="text-lg font-bold mb-2" style="color: ${color};">${title}</h4>
                <div class="no-data text-center p-4 bg-gray-50 rounded">ç„¡${title}</div>
            </div>
        `;
    }
    
    const sortedRecords = records.sort((a, b) => {
        const dateA = new Date(a.è©•åˆ†æ—¥æœŸ || '2000-01-01');
        const dateB = new Date(b.è©•åˆ†æ—¥æœŸ || '2000-01-01');
        return dateB - dateA; // æœ€æ–°æ—¥æœŸåœ¨å‰
    });
    
    return `
        <div class="mb-6 p-4 border-l-4" style="border-left-color: ${color};">
            <h4 class="text-lg font-bold mb-4" style="color: ${color};">${title} (${records.length} æ¢è¨˜éŒ„)</h4>
            ${sortedRecords.map((record, index) => {
                const isLatest = index === 0;
                let detailHtml = Object.keys(record).map(key => {
                    // æ’é™¤æ ¸å¿ƒæ¬„ä½ï¼Œåªé¡¯ç¤ºè©•åˆ†é …ç›®
                    if (!['å“¡å·¥ç·¨è™Ÿ', 'å“¡å·¥å§“å', 'è©•æ ¸äºº', 'ç¸½åˆ†', 'è©•åˆ†æ—¥æœŸ'].includes(key) && 
                        record[key] !== undefined && record[key] !== '' && record[key] != null) {
                        return `<p class="ml-4 text-sm"><span class="font-medium">${key}:</span> <strong>${record[key]}</strong> åˆ†</p>`;
                    }
                    return '';
                }).filter(html => html !== '').join('');

                return `
                    <div class="history-record mb-4 p-4 border rounded-lg ${isLatest ? 'border-green-500 bg-green-50' : 'border-gray-200'}">
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <p class="text-xl font-bold" style="color: ${color};">
                                    ç¸½åˆ†: <span class="text-green-600 text-2xl">${record['ç¸½åˆ†'] || 'N/A'}</span>
                                </p>
                                <p class="text-sm text-gray-600">
                                    <strong>è©•åˆ†æ—¥æœŸï¼š</strong>${record['è©•åˆ†æ—¥æœŸ'] ? new Date(record['è©•åˆ†æ—¥æœŸ']).toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' }) : 'N/A'}
                                </p>
                            </div>
                            
                        </div>
                        
                        ${detailHtml ? `
                        
                            
                            <div class="pt-2">
                                ${detailHtml}
                            </div>
                        
                        ` : ''}
                        
                        ${isLatest ? `
                        <p class="text-red-500 font-bold mt-3 text-sm">
                            *æ‚¨å†æ¬¡æäº¤è©•åˆ†ï¼Œå°‡æœƒè¦†è“‹æ­¤è¨˜éŒ„ã€‚
                        </p>
                        ` : ''}
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

    // ç”Ÿæˆè©•åˆ†æ»‘æ¡¿
    function generateRatingItems(options, prefix) {
        return options.map((option, index) => `
            <div class="rating-item">
                <div class="rating-header"><span class="rating-title">${option.è©•åˆ†é …ç›®}</span></div>
                <div class="rating-range text-xs text-gray-500">è©•åˆ†ç¯„åœ: ${option.æœ€ä½åˆ†} - ${option.æœ€é«˜åˆ†}åˆ†</div>
                <input type="range" class="rating-slider" id="${prefix}-rating-${index}" min="${option.æœ€ä½åˆ†}" max="${option.æœ€é«˜åˆ†}" value="${option.æœ€ä½åˆ†}" step="1">
                <div class="rating-value-display" id="${prefix}-value-${index}">${option.æœ€ä½åˆ†}</div>
            </div>
        `).join('');
    }

    // ç”Ÿæˆåˆ†æ•¸æ˜ç´°
    function generateScoreBreakdown(options, prefix) {
        return options.map((option, index) => `
            <div class="score-item" id="${prefix}-breakdown-${index}">
                <span>${option.è©•åˆ†é …ç›®}:</span>
                <span>${option.æœ€ä½åˆ†} åˆ†</span>
            </div>
        `).join('');
    }

    // è¨ˆç®—æœ€å¤§å¯èƒ½åˆ†æ•¸
    function calculateMaxScore(options) {
        return options.reduce((total, option) => total + option.æœ€é«˜åˆ†, 0);
    }

    // è¨­ç½®è©•åˆ†æ»‘æ¡¿äº‹ä»¶
    function setupRatingSliders(options, prefix) {
        options.forEach((option, index) => {
            const slider = document.getElementById(`${prefix}-rating-${index}`);
            const valueDisplay = document.getElementById(`${prefix}-value-${index}`);
            if (slider && valueDisplay) {
                slider.addEventListener('input', () => {
                    valueDisplay.textContent = slider.value;
                    updateTotalScore(options, prefix);
                });
            }
        });
    }

    // æ›´æ–°ç¸½åˆ†
    function updateTotalScore(options, prefix) {
        let totalScore = 0;
        options.forEach((option, index) => {
            const slider = document.getElementById(`${prefix}-rating-${index}`);
            const breakdown = document.getElementById(`${prefix}-breakdown-${index}`);
            if (slider && breakdown) {
                const score = parseInt(slider.value);
                totalScore += score;
                breakdown.innerHTML = `<span>${option.è©•åˆ†é …ç›®}:</span><span>${score} åˆ†</span>`;
            }
        });
        document.getElementById(`${prefix}TotalScore`).textContent = `ç¸½åˆ†: ${totalScore} / ${calculateMaxScore(options)}`;
    }

    // submit score to Google Sheets (UPDATED)
    async function submitEvaluation(sheetName, options, prefix) {
        if (!currentEvaluator) {
            showCustomMessage('è«‹å…ˆç™»å…¥', 'error');
            window.location.href = "login.html";
            return;
        }

        if (!currentEmployee) {
            showCustomMessage('è«‹å…ˆé¸æ“‡å“¡å·¥', 'error');
            return;
        }

        const evaluationData = {
            'å“¡å·¥ç·¨è™Ÿ': currentEmployee.å“¡å·¥ç·¨è™Ÿ,
            'å“¡å·¥å§“å': currentEmployee.å“¡å·¥å§“å,
            'è©•æ ¸äºº': currentEvaluator,
            'è©•åˆ†æ—¥æœŸ': new Date(),
            'ç¸½åˆ†': 0
        };

        let totalScore = 0;
        options.forEach((option, index) => {
            const slider = document.getElementById(`${prefix}-rating-${index}`);
            if (slider) {
                const score = parseInt(slider.value);
                evaluationData[option.è©•åˆ†é …ç›®] = score;
                totalScore += score;
            }
        });
        evaluationData['ç¸½åˆ†'] = totalScore;

        console.log('æäº¤è©•åˆ†æ•¸æ“š:', evaluationData);

        try {
            const buttons = document.querySelectorAll(`button[onclick*="submitEvaluation('${sheetName}'"]`);
            const button = buttons[0];
            
            button.disabled = true;
            button.textContent = 'æäº¤ä¸­...';

            // Fetch request (using no-cors as it is an App Script post)
            await fetch(scriptURL, {
                method: "POST",
                mode: 'no-cors',
                body: JSON.stringify({
                    action: "saveEvaluation",
                    sheetName: sheetName,
                    data: evaluationData
                })
            });

            
            showCustomMessage(`${sheetName}å·²æˆåŠŸæäº¤ï¼`, 'success');
            
            // 1. Re-fetch history records for detail view update
            await loadHistoryRatings(currentEmployee.å“¡å·¥ç·¨è™Ÿ, currentEvaluator);

            // 2. Re-fetch all ratings for list view update
            const updatedScores = await loadAllEvaluatorRatings(currentEvaluator);
            employeeScores = updatedScores.reduce((acc, score) => {
                acc[score.å“¡å·¥ç·¨è™Ÿ] = score;
                return acc;
            }, {});
            
            // 3. Re-display the employee list if currently on the list view (optional but good practice)
            if (document.getElementById('employeeList').style.display !== 'none') {
                displayEmployees(allEmployees);
            }


        } catch (error) {
            console.error("æäº¤è©•åˆ†å¤±æ•—:", error);
            showCustomMessage("æäº¤è©•åˆ†å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", 'error');
            
        } finally {
            
            setTimeout(() => {
                const buttons = document.querySelectorAll(`button[onclick*="submitEvaluation('${sheetName}'"]`);
                const button = buttons[0];
                button.disabled = false;
                button.textContent = sheetName === SHEETS.TOUR_SCORE ? 'æäº¤è€ƒå¯Ÿåœ˜è©•åˆ†' : 'æäº¤æœƒé¢è©•åˆ†';
            }, 2000);
        }
    }

    // è¿”å›å“¡å·¥åˆ—è¡¨
    function showEmployeeList() {
        document.getElementById('employeeDetail').style.display = 'none';
        document.getElementById('employeeList').style.display = 'block';
        currentEmployee = null;
    }

    // logout (UPDATED - Removed alert())
    function logout() {
        showCustomMessage('å·²ç™»å‡º', 'info');
        localStorage.removeItem("currentEvaluator");
        // history.replaceState(null, '', '/'); // Removed history manipulation for simplicity
        setTimeout(() => {
            window.location.href = "login.html";
        }, 500);
    }
    </script>
</body>
</html>