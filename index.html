<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“¡å·¥è©•åˆ†ç³»çµ±</title>
    
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- æ•´åˆæ‰€æœ‰ CSS æ¨£å¼ -->
    <link rel="stylesheet" href="styles.css">
 
</head>
<body class="bg-gray-100 font-sans">
    <div id="customMessageBox" class="custom-message-box"></div>
    
    <!-- é ‚éƒ¨å°è¦½åˆ— (Sticky Header) -->
   <header class="sticky top-0 z-10 bg-white shadow-md py-3 border-b border-gray-200">
  <div class="container mx-auto flex items-center justify-between px-4">
    
    <!-- Logo + åç¨± -->
    <div class="flex items-center">
        <button 
                        onclick="showEmployeeList()" 
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg shadow transition duration-150">
                        è¿”å›åˆ—è¡¨
                    </button>
      <img src="HongYipLogo.png" class="w-14 h-14 mr-3 object-contain">
      <h1 class="text-xl font-bold text-indigo-700">å“¡å·¥è©•åˆ†ç³»çµ±</h1>
    </div>

    <!-- è¿”å›æŒ‰éˆ• -->
    <span class="text-lg font-medium text-gray-700">
        ç•¶å‰è©•æ ¸äººï¼š
        <span id="currentEvaluatorDisplay" class="font-bold text-indigo-600"></span>
    </span>

    <div class="flex gap-3 mt-3 md:mt-0">
        <button onclick="Ranklist()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg shadow">
            æ’è¡Œæ¦œ
        </button>
        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg shadow">
            ç™»å‡º
        </button>
    </div>
</header>


    <!-- ä¸»å…§å®¹å€å¡Š -->
    <main class="container mx-auto py-8 px-4">
        
        
        
        <div id="employeeList">
            <h2 class="text-2xl font-bold text-gray-800 mb-5 border-b pb-2">æ‰€æœ‰å“¡å·¥</h2>
            <div class="employee-grid" id="employeeGrid">
                <div class="loading">è¼‰å…¥å“¡å·¥è³‡æ–™ä¸­...</div>
            </div>
        </div>

        
        
        <div id="employeeDetail" style="display: none;">
            <div id="basicContent"></div>
        </div>
    </main>

    <script>
    // google sheet config
    const SPREADSHEET_ID = '1znQ2MapAc4fqXJc3SDxoixbrd-b6Xry4auf8vFIcqDc';
    // ç”±æ–¼æˆ‘å€‘ä½¿ç”¨ App Script ä»£ç†å¯«å…¥ï¼ŒSheets API Key å¯èƒ½åªç”¨æ–¼è®€å–ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰ï¼Œé€™è£¡ä¿ç•™
    const API_KEY = 'AIzaSyDj2ktQ36AoBSrYxPj_R4USvzvLtfh8Kb0'; 
    const scriptURL = 'https://script.google.com/macros/s/AKfycby46B_BO5E6cbIxYUngBCcT1Las-zSElgx6k1Kf057WH5_T0xrVQvm1IpmEhAtT47jl/exec';
    
    const SHEETS = {
        BASIC: 'å“¡å·¥è³‡æ–™',
        EDUCATION: 'å­¸æ­·ï¼å°ˆæ¥­è³‡æ ¼',
        EXPERIENCE: 'å·¥ä½œç¶“é©—',
        EMPLOYMENT: 'åº·æ¥­å—åƒ±è¨˜éŒ„',
        RATING: 'è€ƒå¯Ÿåœ˜è©•åˆ†é¸é …',
        INTERVIEW_RATING: 'æœƒé¢è©•åˆ†é¸é …',
        EVALUATORS: 'è©•æ ¸äººåå–®',
        TOUR_SCORE: 'è€ƒå¯Ÿåœ˜æ•´é«”è©•åˆ†', 
        INTERVIEW_SCORE: 'æœƒé¢è©•åˆ†'
    };

    let evaluatorList = [];
    let currentEvaluator = null;
    let allEmployees = [];
    let educationData = [];
    let experienceData = [];
    let employmentData = [];
    let ratingOptions = [];
    let interviewRatingOptions = []; 
    let currentEmployee = null;
    let employeeScores = {}; // å„²å­˜è©•æ ¸äººå°æ‰€æœ‰å“¡å·¥çš„æœ€æ–°è©•åˆ†

    // --- è‡ªå®šç¾©è¨Šæ¯å’Œè¼‰å…¥ç‹€æ…‹å‡½æ•¸ ---
    function showCustomMessage(message, type = 'info') {
        const msgBox = document.getElementById('customMessageBox');
        msgBox.textContent = message;
        msgBox.className = `custom-message-box show ${type}`;
        
        setTimeout(() => {
            msgBox.classList.remove('show');
        }, 3000);
    }

    function showLoading() { 
        document.getElementById('employeeGrid').innerHTML = '<div class="loading text-center text-xl p-10 text-gray-500">è¼‰å…¥ä¸­...</div>'; 
    }
    
    function hideLoading() { 
        // intentionally empty to allow the next displayEmployees call to hide it
    }
    
    function showError(message) { 
        document.getElementById('employeeGrid').innerHTML = `<div class="error text-center text-red-600 p-10 border border-red-300 bg-red-50 rounded-lg">${message}</div>`; 
    }
    
    // ** æ–°å¢å‡½æ•¸: æ›´æ–°è¿”å›æŒ‰éˆ•ç‹€æ…‹ **
    function updateReturnButtonState(isListVisible) {
        const button = document.getElementById('returnToListButton');
        if (!button) return;

        if (isListVisible) {
            button.disabled = true;
            // ç¦ç”¨æ¨£å¼
            button.classList.remove('bg-indigo-500', 'hover:bg-indigo-600', 'text-white', 'shadow-md');
            button.classList.add('bg-gray-200', 'text-gray-500', 'cursor-not-allowed');
        } else {
            button.disabled = false;
            // å•Ÿç”¨æ¨£å¼
            button.classList.remove('bg-gray-200', 'text-gray-500', 'cursor-not-allowed');
            button.classList.add('bg-indigo-500', 'hover:bg-indigo-600', 'text-white', 'shadow-md');
        }
    }


    // check login
    document.addEventListener('DOMContentLoaded', function() {
    const savedEvaluator = localStorage.getItem("currentEvaluator");

    if (!savedEvaluator) {
        window.location.href = "login.html";
        return;
    }

    currentEvaluator = savedEvaluator;
    document.getElementById("currentEvaluatorDisplay").textContent = currentEvaluator;

    const params = new URLSearchParams(window.location.search);
    const employeeIdFromURL = params.get("employeeId");

    if (employeeIdFromURL) {
        // â­ é‡é»ï¼šç›´æ¥é¡¯ç¤ºè©²å“¡å·¥è©•åˆ†é 
        updateReturnButtonState(false); // å•Ÿç”¨è¿”å›
        showEmployeeDetail(employeeIdFromURL);
    } else {
        // â­ æ²’æœ‰æŒ‡å®šå“¡å·¥ï¼Œæ‰é¡¯ç¤ºåˆ—è¡¨
        updateReturnButtonState(true);
       loadAllData().then(() => {
    const employeeId = getEmployeeIdFromURL();
    if (employeeId) {
        showEmployeeDetail(employeeId);
    }
});

    }
});


    // upload data from google sheet
    async function loadSheetData(sheetName) {
        // Since we are using an App Script for evaluation data, the Sheets API for basic employee data is fine.
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(sheetName)}?key=${API_KEY}`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            if (!data.values) return [];
            const headers = data.values[0];
            const rows = data.values.slice(1);
            return rows.map(row => {
                const obj = {};
                headers.forEach((header, index) => obj[header] = row[index] || '');
                return obj;
            });
        } catch (error) {
            console.error(`åŠ è¼‰ ${sheetName} å¤±æ•—:`, error);
            return [];
        }
    }
    
    // NEW FUNCTION: è¼‰å…¥ç•¶å‰è©•æ ¸äººå°æ‰€æœ‰å“¡å·¥çš„æœ€æ–°è©•åˆ†
    async function loadAllEvaluatorRatings(evaluator) {
        if (!evaluator) return [];
        const url = `${scriptURL}?action=getAllEvaluatorRatings&evaluator=${encodeURIComponent(evaluator)}`;
        try {
            const response = await fetch(url);
            const result = await response.json();
            if (result.success) {
                console.log('æ‰€æœ‰è©•åˆ†è¼‰å…¥æˆåŠŸ:', result.data);
                return result.data;
            } else {
                console.error("è¼‰å…¥æ‰€æœ‰è©•åˆ†å¤±æ•—:", result.message);
                return [];
            }
        } catch (error) {
            console.error("è¼‰å…¥æ‰€æœ‰è©•åˆ†å¤±æ•—:", error);
            return [];
        }
    }

    // upload all data
    async function loadAllData() {
        showLoading();
        // ä½¿ç”¨ Promise.all åŠ é€Ÿæ•¸æ“šè¼‰å…¥
        const [basic, education, experience, employment, ratings, interviewRatings, evaluators, allRatings] = await Promise.all([
            loadSheetData(SHEETS.BASIC),
            loadSheetData(SHEETS.EDUCATION),
            loadSheetData(SHEETS.EXPERIENCE),
            loadSheetData(SHEETS.EMPLOYMENT),
            loadSheetData(SHEETS.RATING),
            loadSheetData(SHEETS.INTERVIEW_RATING),
            loadSheetData(SHEETS.EVALUATORS),
            loadAllEvaluatorRatings(currentEvaluator) // Fetch all scores
        ]);

        allEmployees = basic;
        educationData = education;
        experienceData = experience.map(record => ({
            ...record,
            // ç¢ºä¿ã€Œå…¥è·å‰ç¸½å¹´è³‡ã€å­—æ®µå­˜åœ¨ï¼Œå³ä½¿ç‚ºç©ºï¼Œé¿å…æ¨¡æ¿æ¸²æŸ“å•é¡Œ
            'å…¥è·å‰ç¸½å¹´è³‡': record['å…¥è·å‰ç¸½å¹´è³‡'] || '' 
        }));
        employmentData = employment;
        evaluatorList = evaluators.map(e => e.è©•æ ¸äººå§“å || e.è©•æ ¸äºº);

        // è€ƒå¯Ÿåœ˜è©•åˆ†é¸é …
        ratingOptions = ratings.map(row => ({
            'è©•åˆ†é …ç›®': row['è©•åˆ†é …ç›®'] || 'æœªå‘½å',
            'æœ€ä½åˆ†': parseInt(row['æœ€ä½åˆ†']) || 0,
            'æœ€é«˜åˆ†': parseInt(row['æœ€é«˜åˆ†']) || 5
        }));

        // æœƒé¢è©•åˆ†é¸é …
        interviewRatingOptions = interviewRatings.map(row => ({
            'è©•åˆ†é …ç›®': row['è©•åˆ†é …ç›®'] || 'æœªå‘½å',
            'æœ€ä½åˆ†': parseInt(row['æœ€ä½åˆ†']) || 0,
            'æœ€é«˜åˆ†': parseInt(row['æœ€é«˜åˆ†']) || 5
        }));

        // è™•ç†æ‰€æœ‰è©•åˆ†æ•¸æ“šï¼Œè½‰ç‚ºä»¥å“¡å·¥ç·¨è™Ÿç‚ºéµçš„æ˜ å°„
        employeeScores = allRatings.reduce((acc, score) => {
            acc[score.å“¡å·¥ç·¨è™Ÿ] = score;
            return acc;
        }, {});


        displayEmployees(allEmployees);
        hideLoading();
        return true;
    }

    // employee list (UPDATED)
    function displayEmployees(employees) {
        const grid = document.getElementById('employeeGrid');
        if (employees.length === 0) {
            grid.innerHTML = '<div class="error">æ‰¾ä¸åˆ°å“¡å·¥è³‡æ–™</div>';
            return;
        }
        grid.innerHTML = employees.map(emp => {
            const scores = employeeScores[emp.å“¡å·¥ç·¨è™Ÿ] || {};
            
            // æª¢æŸ¥åˆ†æ•¸æ˜¯å¦å­˜åœ¨
            const tourTotal = scores.tourTotal !== null && scores.tourTotal !== undefined ? scores.tourTotal : null;
            const interviewTotal = scores.interviewTotal !== null && scores.interviewTotal !== undefined ? scores.interviewTotal : null;

            // æ ¼å¼åŒ–é¡¯ç¤º
            const tourScoreDisplay = tourTotal !== null 
                ? `<span class="text-green-600 font-bold">${tourTotal} åˆ†</span> <span class="text-xs text-gray-400">(${scores.tourDate ? scores.tourDate.substring(0, 10) : 'N/A'})</span>` 
                : '<span class="text-red-500">æœªè©•åˆ†</span>';
            const interviewScoreDisplay = interviewTotal !== null 
                ? `<span class="text-blue-600 font-bold">${interviewTotal} åˆ†</span> <span class="text-xs text-gray-400">(${scores.interviewDate ? scores.interviewDate.substring(0, 10) : 'N/A'})</span>` 
                : '<span class="text-red-500">æœªè©•åˆ†</span>';

            return `
                <div class="employee-card" onclick="showEmployeeDetail('${emp.å“¡å·¥ç·¨è™Ÿ}')">
                    <h3 class="text-xl font-bold text-[#004d99] mb-2">${emp.å“¡å·¥å§“å || 'ç„¡å§“å'} (${emp.å“¡å·¥ç·¨è™Ÿ || 'ç„¡ç·¨è™Ÿ'})</h3>
                    <div class="employee-info text-sm text-gray-700">
                        <p><strong>éƒ¨é–€ï¼š</strong>${emp.éƒ¨é–€ || 'æœªå¡«å¯«'}</p>
                        <p><strong>è·ä½ï¼š</strong>${emp.è·ä½ || 'æœªå¡«å¯«'}</p>
                    </div>
                    <div class="rating-summary mt-3 pt-3 border-t border-gray-200">
                        <div class="flex justify-between items-center text-sm mb-1">
                            <span class="font-medium text-gray-500">è€ƒå¯Ÿåœ˜è©•åˆ†:</span>
                            ${tourScoreDisplay}
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="font-medium text-gray-500">æœƒé¢è©•åˆ†:</span>
                            ${interviewScoreDisplay}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // employee info. (UPDATED to include Employee Photo)
    function showEmployeeDetail(employeeId) {
        currentEmployee = allEmployees.find(emp => emp.å“¡å·¥ç·¨è™Ÿ === employeeId);
        if (!currentEmployee) return;

        document.getElementById('employeeList').style.display = 'none';
        document.getElementById('employeeDetail').style.display = 'block';
        
        // **æ›´æ–°æŒ‰éˆ•ç‹€æ…‹ç‚ºå•Ÿç”¨**
        updateReturnButtonState(false); 
        
        displayAllInfo(); // å‘¼å«æ›´æ–°å¾Œçš„é¡¯ç¤ºå‡½å¼

        updateTotalScore(ratingOptions, 'rating');
        updateTotalScore(interviewRatingOptions, 'interview');
        
        // ç¢ºä¿é€™è£¡æœ‰å®šç¾© loadHistoryRatings å‡½å¼ä¸¦æ­£ç¢ºä½¿ç”¨
        loadHistoryRatings(employeeId, currentEvaluator); 
    }

    function displayAllInfo() {
        const content = document.getElementById('basicContent');
        const employee = currentEmployee;

        const educationRecords = educationData.filter(edu => edu.å“¡å·¥ç·¨è™Ÿ === employee.å“¡å·¥ç·¨è™Ÿ);
        const experienceRecords = experienceData.filter(exp => exp.å“¡å·¥ç·¨è™Ÿ === employee.å“¡å·¥ç·¨è™Ÿ);
        const employmentRecords = employmentData.filter(emp => emp.å“¡å·¥ç·¨è™Ÿ === employee.å“¡å·¥ç·¨è™Ÿ);

        // æª¢æŸ¥å“¡å·¥ç…§ç‰‡å­—æ®µä¸¦ç”Ÿæˆ HTML
        const employeePhotoUrl = employee.å“¡å·¥ç…§ç‰‡ && employee.å“¡å·¥ç…§ç‰‡.startsWith('http') ? employee.å“¡å·¥ç…§ç‰‡ : null;
        
        // **ç›´é•·æ–¹å½¢ç…§ç‰‡ (Vertical Rectangle - ID Photo Style) æ¨£å¼**
        // ä½¿ç”¨ w-32 h-48 (128px x 192px) å»ºç«‹ç›´ç«‹é•·æ–¹å½¢æ¯”ä¾‹
        const photoPlaceholderUrl = `https://placehold.co/128x192/004d99/ffffff?text=${(employee.å“¡å·¥å§“å || 'ç„¡').substring(0, 1)}%20(ç„¡ç…§ç‰‡)`;
        
        console.log(`å“¡å·¥ ${employee.å“¡å·¥å§“å} çš„ç…§ç‰‡ URL (è¨ºæ–·):`, employeePhotoUrl);

        // ä½¿ç”¨ w-32 h-48, rounded-lg (ç›´é•·æ–¹å½¢)ï¼Œä¸¦æ·»åŠ  shadow-xl å¢åŠ ç«‹é«”æ„Ÿ
        const employeePhotoHtml = employeePhotoUrl 
            ? `<img src="${employeePhotoUrl}" alt="${employee.å“¡å·¥å§“å} - å“¡å·¥ç…§ç‰‡" class="w-32 h-48 object-cover rounded-lg shadow-xl mb-4 bg-gray-200" onerror="this.onerror=null; this.src='${photoPlaceholderUrl}';">` 
            : `<div class="w-32 h-48 flex items-center justify-center bg-gray-200 rounded-lg text-gray-500 shadow-xl text-3xl font-semibold mb-4">${(employee.å“¡å·¥å§“å || 'ç„¡').substring(0, 2)}</div>`;


        content.innerHTML = `
            <div class="detail-section">
                <h3>ğŸ‘¤ åŸºæœ¬è³‡æ–™ - ${employee.å“¡å·¥å§“å}</h3>
                
                <div class="grid grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- å“¡å·¥ç…§ç‰‡æ¬„ä½ (å·¦å´) - å¢åŠ  flex flex-col items-center è®“å›ºå®šå°ºå¯¸çš„ç›´é•·æ–¹å½¢ç…§ç‰‡å±…ä¸­ -->
                   
                    <!-- åŸºæœ¬è³‡æ–™ (å³å´) -->
                    
                        <div class="education-record border-b pb-2 mb-2">
                            <p><strong>å“¡å·¥ç·¨è™Ÿï¼š</strong>${employee.å“¡å·¥ç·¨è™Ÿ || 'æœªå¡«å¯«'}</p>
                            <p><strong>å¹´é½¡ï¼š</strong>${employee.å¹´é½¡ || 'æœªå¡«å¯«'}</p>
                            <p><strong>å©šå§»ç‹€æ³ï¼š</strong>${employee.å©šå§»ç‹€æ³ || 'æœªå¡«å¯«'}</p>
                            <p><strong>å­å¥³æ•¸ç›®ï¼š</strong>${employee.å­å¥³æ•¸ç›® || '0'}</p>
                            <p><strong>è·ä½ï¼š</strong>${employee.è·ä½ || 'æœªå¡«å¯«'}</p>
                            <p><strong>åœ°åŸŸï¼š</strong>${employee.åœ°åŸŸ || 'æœªå¡«å¯«'}</p>
                            <p><strong>éƒ¨é–€/åˆ†å€ï¼š</strong>${employee.éƒ¨é–€ || 'æœªå¡«å¯«'}</p>
                            <p><strong>ç¸¾æ•ˆè©•ä¼°ç­‰ç´š2023ï¼š</strong>${employee.ç¸¾æ•ˆè©•ä¼°ç­‰ç´š2023 || 'æœªå¡«å¯«'}</p>
                            <p><strong>ç¸¾æ•ˆè©•ä¼°ç­‰ç´š2024ï¼š</strong>${employee.ç¸¾æ•ˆè©•ä¼°ç­‰ç´š2024 || 'æœªå¡«å¯«'}</p>
                             <p><strong>æœå‹™å¹´è³‡ï¼š</strong>${employee.æœå‹™å¹´è³‡ || 'æœªå¡«å¯«'}</p>
                        </div>
                    
                     <div class="lg:col-span-1 flex flex-col items-center">
                        ${employeePhotoHtml}
                        
                    </div>
                </div>
            </div>

                <div class="detail-section">
                    <h3>ğŸ“ å­¸æ­·ï¼å°ˆæ¥­è³‡æ ¼</h3>
                    ${educationRecords.length > 0 ? educationRecords.map(record => `
                        <div class="education-record border-b pb-2 mb-2">
                            <p><strong>æœŸé–“ï¼š</strong>${record.ç”± || ''} - ${record.è‡³ || ''}</p>
                            <p><strong>å­¸é™¢åç¨±ï¼š</strong>${record.å­¸é™¢åç¨± || ''}</p>
                            <p><strong>æ‰€ç²è­‰æ›¸/è³‡æ ¼ï¼š</strong>${record.æ‰€ç²è­‰æ›¸è³‡æ ¼ || ''}</p>
                        </div>
                    `).join('') : '<div class="no-data text-gray-500">æ²’æœ‰å­¸æ­·è³‡æ ¼è¨˜éŒ„</div>'}
                </div>

                <div class="detail-section">
                    <h3>ğŸ¢ å·¥ä½œç¶“é©—</h3>
                    ${experienceRecords.length > 0 ? experienceRecords.map(record => `
                        <div class="experience-record border-b pb-2 mb-2">
                            <p><strong>æœŸé–“ï¼š</strong>${record.ç”± || ''} - ${record.è‡³ || ''}</p>
                            <p><strong>å…¬å¸åç¨±ï¼š</strong>${record.å…¬å¸åç¨± || ''}</p>
                            <p><strong>é›¢è·æ™‚è·ä½ï¼š</strong>${record.é›¢è·æ™‚è·ä½ || ''}</p>
                            <p><strong>è©²å·¥ä½œå¹´è³‡ï¼š</strong>${record.è©²è·ä½å¹´è³‡ || ''}</p>
                        </div>
                    `).join('') : '<div class="no-data text-gray-500">æ²’æœ‰å·¥ä½œç¶“é©—è¨˜éŒ„</div>'}
                </div>

                <div class="detail-section">
                    <h3>ğŸ“‹ åº·æ¥­å—åƒ±è¨˜éŒ„</h3>
                    ${employmentRecords.length > 0 ? employmentRecords.map(record => `
                        <div class="employment-record border-b pb-2 mb-2">
                            <p><strong>æœŸé–“ï¼š</strong>${record.ç”± || ''} - ${formatEndDate(record.è‡³)}</p>
                            <p><strong>åˆ†å€ï¼š</strong>${record.åˆ†å€ || ''}</p>
                            <p><strong>å¤§å»ˆï¼š</strong>${record.å¤§å»ˆ || ''}</p>
                            <p><strong>è·ä½ï¼š</strong>${record.è·ä½ || ''}</p>
                            <p><strong>å¹´è³‡ï¼š</strong>${record.å¹´è³‡ || ''}</p>
                        </div>
                    `).join('') : '<div class="no-data text-gray-500">æ²’æœ‰å—åƒ±è¨˜éŒ„</div>'}
                </div>

                <!-- æ­·å²è©•åˆ†è¨˜éŒ„å€å¡Š -->
                <div class="detail-section mt-8">
                    <h3>ğŸ“œ ä¸Šæ¬¡è©•åˆ†è¨˜éŒ„ (${currentEvaluator} çš„è©•åˆ†)</h3>
                    <div id="historyRatingsContainer">æ­£åœ¨è¼‰å…¥æ‚¨çš„æ­·å²è¨˜éŒ„...</div>
                </div>
                
                <!-- è€ƒå¯Ÿåœ˜è©•åˆ†è¡¨å–® -->
                <div class="evaluation-form">
                    <h3>ğŸ“ è€ƒå¯Ÿåœ˜æ•´é«”è©•åˆ†</h3>
                    <div class="evaluator-display text-lg font-medium mb-4 text-gray-600">è©•æ ¸äººï¼š${currentEvaluator}</div>
                    <div id="ratingItemsContainer">${generateRatingItems(ratingOptions, 'rating')}</div>
                    <div class="score-breakdown" id="ratingScoreBreakdown">${generateScoreBreakdown(ratingOptions, 'rating')}</div>
                    <div class="total-score" id="ratingTotalScore">è€ƒç¸½åˆ†: 0 / ${calculateMaxScore(ratingOptions)}</div>
                    <!-- REMOVED: <button class="submit-button" onclick="submitEvaluation('${SHEETS.TOUR_SCORE}', ratingOptions, 'rating')">æäº¤è€ƒå¯Ÿåœ˜è©•åˆ†</button> -->
                </div>

                <!-- æœƒé¢è©•åˆ†è¡¨å–® -->
                <div class="interview-form">
                    <h3>ğŸ“ æœƒé¢è©•åˆ†</h3>
                    <div class="evaluator-display text-lg font-medium mb-4 text-gray-600">è©•æ ¸äººï¼š${currentEvaluator}</div>
                    <div id="interviewRatingItemsContainer">${generateRatingItems(interviewRatingOptions, 'interview')}</div>
                    <div class="score-breakdown" id="interviewScoreBreakdown">${generateScoreBreakdown(interviewRatingOptions, 'interview')}</div>
                    <div class="total-score" id="interviewTotalScore">ç¸½åˆ†: 0 / ${calculateMaxScore(interviewRatingOptions)}</div>
                    <!-- REMOVED: <button class="submit-button" onclick="submitEvaluation('${SHEETS.INTERVIEW_SCORE}', interviewRatingOptions, 'interview')">æäº¤æœƒé¢è©•åˆ†</button> -->
                </div>
                
                <!-- NEW: Combined Submission Button -->
                <div class="combined-submission mt-10">
                    <button class="submit-button" id="submitAllButton" onclick="submitAllEvaluations()">
                        æäº¤è©•åˆ† (è€ƒå¯Ÿåœ˜ & æœƒé¢)
                    </button>
                </div>
            `;

            // ç¶å®šè©•åˆ†æ»‘æ¡¿äº‹ä»¶
            setupRatingSliders(ratingOptions, 'rating');
            setupRatingSliders(interviewRatingOptions, 'interview');
    }

    function formatEndDate(endDate) {
    if (!endDate) return '';

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const end = new Date(endDate);
    end.setHours(0, 0, 0, 0);

    // å¦‚æœã€Œè‡³ã€æ˜¯ä»Šå¤©æˆ–æœªä¾† â†’ è¦–ç‚ºä»åœ¨è·
    if (!isNaN(end) && end >= today) {
        return 'ç¾åœ¨';
    }

    // æ­£å¸¸é¡¯ç¤ºæ—¥æœŸ
    return endDate;
}


    function getEmployeeIdFromURL() {
    const params = new URLSearchParams(window.location.search);
    return params.get("employeeId");
}


    
    // history
    async function loadHistoryRatings(employeeId, evaluator) {
        const container = document.getElementById('historyRatingsContainer');
        if (!container) {
            console.error('æ‰¾ä¸åˆ°æ­·å²è¨˜éŒ„å®¹å™¨');
            return;
        }
        
        container.innerHTML = '<div class="no-data text-center p-5 text-blue-500">æ­£åœ¨è¼‰å…¥æ­·å²è©•åˆ†...</div>';

        // Mock Data for App Script Placeholder
        if (scriptURL === 'YOUR_APP_SCRIPT_URL_HERE') {
            console.warn("ä½¿ç”¨ Mock æ­·å²è¨˜éŒ„ï¼Œè«‹æª¢æŸ¥ scriptURL æ˜¯å¦å·²è¨­å®šã€‚");
            const mockHistory = {
                tour: [
                    { 'å“¡å·¥ç·¨è™Ÿ': employeeId, 'å“¡å·¥å§“å': currentEmployee.å“¡å·¥å§“å, 'è©•æ ¸äºº': evaluator, 'ç¸½åˆ†': '8', 'è©•åˆ†æ—¥æœŸ': '2024/05/01', 'é ˜å°åŠ›': '4', 'åœ˜éšŠåˆä½œ': '4' },
                    { 'å“¡å·¥ç·¨è™Ÿ': employeeId, 'å“¡å·¥å§“å': currentEmployee.å“¡å·¥å§“å, 'è©•æ ¸äºº': evaluator, 'ç¸½åˆ†': '7', 'è©•åˆ†æ—¥æœŸ': '2023/11/10', 'é ˜å°åŠ›': '3', 'åœ˜éšŠåˆä½œ': '4' }
                ],
                interview: [
                    { 'å“¡å·¥ç·¨è™Ÿ': employeeId, 'å“¡å·¥å§“å': currentEmployee.å“¡å·¥å§“å, 'è©•æ ¸äºº': evaluator, 'ç¸½åˆ†': '16', 'è©•åˆ†æ—¥æœŸ': '2024/05/01', 'æºé€šèƒ½åŠ›': '7', 'å°ˆæ¥­çŸ¥è­˜': '9' }
                ]
            };
            
            const tourTotalSum = calculateRecordsTotalSum(mockHistory.tour);
            const interviewTotalSum = calculateRecordsTotalSum(mockHistory.interview);
            const combinedTotalSum = tourTotalSum + interviewTotalSum;
            
            container.innerHTML = renderCombinedHistory(mockHistory, tourTotalSum, interviewTotalSum, combinedTotalSum);
            return;
        }

        try {
            const url = `${scriptURL}?action=getRatings&employeeId=${encodeURIComponent(employeeId)}&evaluator=${encodeURIComponent(evaluator)}`;
            
            console.log("è¼‰å…¥æ­·å²è©•åˆ† URL:", url);
            
            const response = await fetch(url);
            
            if (!response.ok) {
                 // é€™è£¡åªæ•ç²ç¶²è·¯éŒ¯èª¤ï¼ŒApp Script çš„é‚è¼¯éŒ¯èª¤æœƒåœ¨çµæœä¸­æª¢æŸ¥
                throw new Error("ç¶²çµ¡éŒ¯èª¤æˆ–ä¼ºæœå™¨ç„¡éŸ¿æ‡‰");
            }
            
            const result = await response.json(); 

            if (!result.success) {
                container.innerHTML = `<div class="no-data text-center p-5 border border-yellow-400 bg-yellow-50">è¼‰å…¥æ­·å²å¤±æ•—: ${result.message}</div>`;
                return;
            }

            const allHistory = result.data;
            
            if (!allHistory || (allHistory.tour.length === 0 && allHistory.interview.length === 0)) {
                container.innerHTML = '<div class="no-data text-center p-5 bg-gray-100 rounded-lg text-gray-500">ç„¡ç›¸é—œæ­·å²è©•åˆ†è¨˜éŒ„ã€‚</div>';
                return;
            }
            
            const tourTotalSum = calculateRecordsTotalSum(allHistory.tour);
            const interviewTotalSum = calculateRecordsTotalSum(allHistory.interview);
            const combinedTotalSum = tourTotalSum + interviewTotalSum;

            container.innerHTML = renderCombinedHistory(allHistory, tourTotalSum, interviewTotalSum, combinedTotalSum);
            
        } catch (error) {
            console.error("è¼‰å…¥æ­·å²è©•åˆ†å¤±æ•—:", error);
            container.innerHTML = `
                <div class="no-data text-center p-5 border border-red-400 bg-red-100 text-red-700 rounded-lg">
                    ç„¡æ³•è¼‰å…¥æ­·å²è¨˜éŒ„<br>
                    <small>éŒ¯èª¤: ${error.message}</small>
                    <br><br>
                    <button onclick="loadHistoryRatings('${employeeId}', '${evaluator}')" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded mt-2">
                        é‡æ–°è¼‰å…¥
                    </button>
                </div>
            `;
        }
    }
    
    // Helper function to render the combined history view
    

    // UPDATED: æ¥æ”¶ä¸¦é¡¯ç¤ºç´¯ç©ç¸½å’Œ (å–®ç¨å€å¡Šç¸½å’Œ)
    function renderHistorySection(records, title, color, sectionTotalSum) {
        if (records.length === 0) {
            return `
                <div class="mb-6 p-4 border-l-4 rounded-lg shadow-inner" style="border-left-color: ${color}; background-color: ${color}10;">
                    <h4 class="text-xl font-bold mb-4" style="color: ${color};">${title} (0 æ¢è¨˜éŒ„)</h4>
                    <!-- ğŸ† ç´¯ç©ç¸½åˆ†é¡¯ç¤º -->
                    <div class="p-4 mb-4 bg-white rounded-xl shadow-lg text-center border-b-4 border-indigo-400">
                        <h5 class="text-lg font-semibold text-gray-700">è©²é¡åˆ¥æ‰€æœ‰ç´€éŒ„ç´¯ç©å–®é …åˆ†æ•¸ç¸½å’Œï¼š</h5>
                        <p class="text-5xl font-black text-indigo-700 mt-1">${sectionTotalSum.toFixed(1)}</p>
                        <p class="text-xs text-gray-500 mt-2">ï¼ˆæ‰€æœ‰æ­·å²å–®é …åˆ†æ•¸çš„ç¸½å’Œï¼‰</p>
                    </div>
                    <div class="no-data text-center p-4 bg-gray-50 rounded text-gray-500">ç„¡${title}</div>
                </div>
            `;
        }
        
        const sortedRecords = records.sort((a, b) => {
            const dateA = new Date(a.è©•åˆ†æ—¥æœŸ || '2000-01-01');
            const dateB = new Date(b.è©•åˆ†æ—¥æœŸ || '2000-01-01');
            return dateB - dateA; // æœ€æ–°æ—¥æœŸåœ¨å‰
        });
        
        return `
            <div class="mb-6 p-4 border-l-4 rounded-lg shadow-inner" style="border-left-color: ${color}; background-color: ${color}10;">
                <h4 class="text-xl font-bold mb-4" style="color: ${color};">${title} (${records.length} æ¢è¨˜éŒ„)</h4>
                
                
                
                ${sortedRecords.map((record, index) => {
                    const isLatest = index === 0;
                    let detailHtml = Object.keys(record).map(key => {
                        // æ’é™¤æ ¸å¿ƒæ¬„ä½ï¼Œåªé¡¯ç¤ºè©•åˆ†é …ç›®
                        if (!['å“¡å·¥ç·¨è™Ÿ', 'å“¡å·¥å§“å', 'è©•æ ¸äºº', 'ç¸½åˆ†', 'è©•åˆ†æ—¥æœŸ'].includes(key) && 
                            record[key] !== undefined && record[key] !== '' && record[key] != null) {
                            return `<p class="ml-4 text-sm text-gray-700"><span class="font-medium">${key}:</span> <strong>${record[key]}</strong> åˆ†</p>`;
                        }
                        return '';
                    }).filter(html => html !== '').join('');

                    return `
                        <div class="history-record mb-4 p-4 border rounded-lg transition-shadow ${isLatest ? 'border-green-500 bg-green-50 shadow-md' : 'border-gray-200 bg-white'}">
                            <div class="flex justify-between items-center mb-2">
                                <div>
                                    <p class="text-xl font-bold" style="color: ${color};">
                                        ç¸½åˆ†: <span class="text-green-600 text-2xl">${record['ç¸½åˆ†'] || 'N/A'}</span>
                                    </p>
                                    <p class="text-sm text-gray-600">
                                        <strong>è©•åˆ†æ—¥æœŸï¼š</strong>${record['è©•åˆ†æ—¥æœŸ'] ? new Date(record['è©•åˆ†æ—¥æœŸ']).toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' }) : 'N/A'}
                                    </p>
                                </div>
                                
                            </div>
                            
                            ${detailHtml ? `
                                
                                <div class="pt-2">
                                    ${detailHtml}
                                </div>
                            
                            ` : ''}
                            
                            ${isLatest ? `
                            <p class="text-red-500 font-bold mt-3 text-sm border-t pt-2 border-red-200">
                                *å¦‚æœæ‚¨å†æ¬¡æäº¤è©•åˆ†ï¼Œå°‡æœƒè¦†è“‹æ­¤è¨˜éŒ„ã€‚
                            </p>
                            ` : ''}
                        </div>
                    `;
                    
                }).join('')}
            </div>
        `;
    }

    function renderCombinedHistory(allHistory, tourTotalSum, interviewTotalSum, combinedTotalSum) {
        let combinedTotalHtml = '';
        if (combinedTotalSum > 0) {
            combinedTotalHtml = `
                <div class="p-6 mb-8 rounded-xl shadow-2xl text-center  border-4 ">
                    <h5 class="text-xl font-bold text-gray-800 mb-2">ç¸½åˆ† (è€ƒå¯Ÿåœ˜ + æœƒé¢)</h5>
                    <p class="text-6xl font-black text-red-600 mt-1">${combinedTotalSum.toFixed(1)}</p>
                    <p class="text-sm text-gray-600 mt-2">
                        è€ƒå¯Ÿåœ˜ç´¯ç©ç¸½å’Œ: ${tourTotalSum.toFixed(1)} + æœƒé¢ç´¯ç©ç¸½å’Œ: ${interviewTotalSum.toFixed(1)}
                    </p>
                </div>
            `;
        } else {
            combinedTotalHtml = `
                <div class="p-4 mb-4 bg-gray-100 rounded-lg text-gray-500 text-center">
                    ç„¡æ­·å²è©•åˆ†æ•¸æ“šç´¯ç©ã€‚
                </div>
            `;
        }
        
        return `
            ${combinedTotalHtml}
            ${renderHistorySection(allHistory.tour, 'è€ƒå¯Ÿåœ˜è©•åˆ†ç´€éŒ„', '#004d99', tourTotalSum)}
            ${renderHistorySection(allHistory.interview, 'æœƒé¢è©•åˆ†ç´€éŒ„', '#004d99', interviewTotalSum)}
        `;
    }

     function calculateRecordsTotalSum(records) {
        if (!Array.isArray(records)) {
            return 0;
        }
        // records é™£åˆ—ä¸­çš„æ¯å€‹ç‰©ä»¶éƒ½æœ‰ä¸€å€‹ 'ç¸½åˆ†' æ¬„ä½
        return records.reduce((sum, record) => {
            // å˜—è©¦å°‡ 'ç¸½åˆ†' è§£æç‚ºæµ®é»æ•¸ï¼Œå¦‚æœä¸æ˜¯æœ‰æ•ˆæ•¸å­—å‰‡è¦–ç‚º 0
            const score = parseFloat(record['ç¸½åˆ†']);
            return sum + (isNaN(score) ? 0 : score);
        }, 0);
    }

    // ç”Ÿæˆè©•åˆ†æ»‘æ¡¿
    function generateRatingItems(options, prefix) {
        return options.map((option, index) => `
            <div class="rating-item">
                <div class="rating-header"><span class="rating-title">${option.è©•åˆ†é …ç›®}</span></div>
                <div class="rating-range text-xs text-gray-500">è©•åˆ†ç¯„åœ: ${option.æœ€ä½åˆ†} - ${option.æœ€é«˜åˆ†}åˆ†</div>
                <input type="range" class="rating-slider" id="${prefix}-rating-${index}" min="${option.æœ€ä½åˆ†}" max="${option.æœ€é«˜åˆ†}" value="${option.æœ€ä½åˆ†}" step="1">
                <div class="rating-value-display" id="${prefix}-value-${index}">${option.æœ€ä½åˆ†}</div>
            </div>
        `).join('');
    }

    // ç”Ÿæˆåˆ†æ•¸æ˜ç´°
    function generateScoreBreakdown(options, prefix) {
        return options.map((option, index) => `
            <div class="score-item" id="${prefix}-breakdown-${index}">
                <span>${option.è©•åˆ†é …ç›®}:</span>
                <span>${option.æœ€ä½åˆ†} åˆ†</span>
            </div>
        `).join('');
    }

    // è¨ˆç®—æœ€å¤§å¯èƒ½åˆ†æ•¸
    function calculateMaxScore(options) {
        return options.reduce((total, option) => total + option.æœ€é«˜åˆ†, 0);
    }

    // è¨­ç½®è©•åˆ†æ»‘æ¡¿äº‹ä»¶
    function setupRatingSliders(options, prefix) {
        options.forEach((option, index) => {
            const slider = document.getElementById(`${prefix}-rating-${index}`);
            const valueDisplay = document.getElementById(`${prefix}-value-${index}`);
            if (slider && valueDisplay) {
                slider.addEventListener('input', () => {
                    valueDisplay.textContent = slider.value;
                    updateTotalScore(options, prefix);
                });
            }
        });
    }

    // æ›´æ–°ç¸½åˆ†
    function updateTotalScore(options, prefix) {
        let totalScore = 0;
        options.forEach((option, index) => {
            const slider = document.getElementById(`${prefix}-rating-${index}`);
            const breakdown = document.getElementById(`${prefix}-breakdown-${index}`);
            if (slider && breakdown) {
                const score = parseInt(slider.value);
                totalScore += score;
                breakdown.innerHTML = `<span>${option.è©•åˆ†é …ç›®}:</span><span>${score} åˆ†</span>`;
            }
        });
        document.getElementById(`${prefix}TotalScore`).textContent = `ç¸½åˆ†: ${totalScore} / ${calculateMaxScore(options)}`;
    }
    
    // Helper function to prepare data for a single submission
    function prepareEvaluationData(options, prefix) {
        const evaluationData = {
            'å“¡å·¥ç·¨è™Ÿ': currentEmployee.å“¡å·¥ç·¨è™Ÿ,
            'å“¡å·¥å§“å': currentEmployee.å“¡å·¥å§“å,
            'è©•æ ¸äºº': currentEvaluator,
            'è©•åˆ†æ—¥æœŸ': new Date().toISOString(),
            'ç¸½åˆ†': 0
        };

        let totalScore = 0;
        options.forEach((option, index) => {
            const slider = document.getElementById(`${prefix}-rating-${index}`);
            if (slider) {
                const score = parseInt(slider.value);
                evaluationData[option.è©•åˆ†é …ç›®] = score;
                totalScore += score;
            }
        });
        evaluationData['ç¸½åˆ†'] = totalScore;
        return evaluationData;
    }

    // Core function to submit a single evaluation type
    async function submitEvaluationSingle(sheetName, evaluationData) {
        console.log(`æäº¤ ${sheetName} æ•¸æ“š:`, evaluationData);
        
        // ä½¿ç”¨ no-cors æ¨¡å¼ç™¼é€åˆ° App Script
        const response = await fetch(scriptURL, {
            method: "POST",
            mode: 'no-cors', // Cannot check response.ok in this mode, rely on network success.
            body: JSON.stringify({
                action: "saveEvaluation",
                sheetName: sheetName,
                data: evaluationData
            })
        });

        // Since it's no-cors, we assume success if the fetch completes without a network error.
        if (response) {
            return { success: true, sheet: sheetName, total: evaluationData['ç¸½åˆ†'] };
        } else {
            // This case might not be hit often due to no-cors, but kept for robustness.
            throw new Error(`ç¶²è·¯è«‹æ±‚å¤±æ•— (${sheetName})`);
        }
    }

    // NEW: Combined function to submit both evaluations
    async function submitAllEvaluations() {
        const button = document.getElementById('submitAllButton');
        if (!currentEvaluator || !currentEmployee) {
            showCustomMessage('è«‹å…ˆç™»å…¥ä¸¦é¸æ“‡å“¡å·¥', 'error');
            return;
        }

        const originalButtonText = button.textContent;
        
        try {
            // 1. ç¦ç”¨æŒ‰éˆ•ä¸¦é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            button.disabled = true;
            button.textContent = 'è™•ç†ä¸­... è«‹å‹¿é—œé–‰';
            showCustomMessage('é–‹å§‹æäº¤æ‰€æœ‰è©•åˆ†...', 'info');

            // 2. æº–å‚™æ•¸æ“š
            const tourData = prepareEvaluationData(ratingOptions, 'rating');
            const interviewData = prepareEvaluationData(interviewRatingOptions, 'interview');

            // 3. åŸ·è¡Œå¹³è¡Œæäº¤
            const [tourResult, interviewResult] = await Promise.all([
                submitEvaluationSingle(SHEETS.TOUR_SCORE, tourData),
                submitEvaluationSingle(SHEETS.INTERVIEW_SCORE, interviewData)
            ]);

            // 4. é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            showCustomMessage(`è€ƒå¯Ÿåœ˜è©•åˆ† (${tourResult.total} åˆ†) å’Œ æœƒé¢è©•åˆ† (${interviewResult.total} åˆ†) å·²æˆåŠŸæäº¤ï¼`, 'success');

            
            // 5. å»¶é²å¾Œæ›´æ–°æ­·å²è¨˜éŒ„å’Œåˆ—è¡¨ (çµ¦ App Script å¯«å…¥æ™‚é–“)
            setTimeout(() => {
                loadHistoryRatings(currentEmployee.å“¡å·¥ç·¨è™Ÿ, currentEvaluator);
                loadAllData(); // æ›´æ–°å“¡å·¥åˆ—è¡¨ä¸Šçš„ç¸½åˆ†æ‘˜è¦
            }, 3000); // å»¶é² 3 ç§’ï¼Œç¢ºä¿ Google App Script è™•ç†å®Œæˆ

        } catch (error) {
            console.error("æäº¤æ‰€æœ‰è©•åˆ†å¤±æ•—:", error);
            showCustomMessage(`æäº¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡æˆ–App Scriptç‹€æ…‹ã€‚éŒ¯èª¤: ${error.message}`, 'error');
        } finally {
            // 6. æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
             setTimeout(() => {
                button.disabled = false;
                button.textContent = originalButtonText;
            }, 3500); // ç¢ºä¿åœ¨æ•¸æ“šæ›´æ–°å®Œæˆå¾Œæ¢å¾©æŒ‰éˆ•
        }
    }


    // è¿”å›å“¡å·¥åˆ—è¡¨
    function showEmployeeList() {
        document.getElementById('employeeDetail').style.display = 'none';
        document.getElementById('employeeList').style.display = 'block';
        currentEmployee = null;
        // **æ›´æ–°æŒ‰éˆ•ç‹€æ…‹ç‚ºç¦ç”¨**
        updateReturnButtonState(true); 
    }

    // logout (UPDATED - Removed alert())
    function logout() {
        showCustomMessage('å·²ç™»å‡º', 'info');
        localStorage.removeItem("currentEvaluator");
        setTimeout(() => {
            window.location.href = "login.html";
        }, 500);
    }

    function Ranklist() {
        
        
        setTimeout(() => {
            window.location.href = "RankList.html";
        }, 500);
    }
    </script>
</body>
</html>