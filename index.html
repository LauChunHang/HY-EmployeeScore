<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“¡å·¥è©•åˆ†ç³»çµ±</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Noto Sans TC', 'Arial', sans-serif; /* è€ƒæ…®ä¸­æ–‡å­—é«” */
            background-color: #eef1f5; /* è¼•å¾®çš„èƒŒæ™¯è‰² */
            padding: 20px;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); /* æ›´æŸ”å’Œçš„é™°å½± */
        }

        h1 {
            text-align: center;
            color: #004d99; /* ä¼æ¥­è—è‰² */
            margin-bottom: 30px;
            font-size: 28px;
            border-bottom: 3px solid #004d99;
            padding-bottom: 10px;
        }

        /* --- è©•æ ¸äººè³‡è¨Šèˆ‡ç™»å‡ºæŒ‰éˆ• --- */
        .evaluator-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 15px;
            background: #f0f8ff;
            border-radius: 8px;
            border: 1px solid #cceeff;
            font-weight: bold;
            color: #004d99;
        }
        
        .logout-button {
            padding: 8px 15px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: normal;
        }
        
        .logout-button:hover {
            background: #e55a5a;
        }


        /* --- æœå°‹æ¬„ --- */
        .search-box {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .search-box input {
            width: 100%;
            padding: 12px;
            border: 1px solid #c0c0c0;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .search-box input:focus {
            border-color: #004d99;
            box-shadow: 0 0 5px rgba(0, 77, 153, 0.3);
            outline: none;
        }

        /* --- å“¡å·¥åˆ—è¡¨ç¶²æ ¼ --- */
        .employee-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .employee-card {
            border: 1px solid #e0e0e0;
            border-left: 5px solid #004d99; /* çªå‡ºæ¨™è­˜ */
            border-radius: 8px;
            padding: 20px;
            background: #ffffff;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            cursor: pointer;
        }

        .employee-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
            border-left-color: #007bff;
        }

        .employee-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            border-bottom: 1px dashed #e0e0e0;
            padding-bottom: 8px;
            font-size: 18px;
        }

        .employee-info p {
            margin: 8px 0;
            color: #555;
            font-size: 15px;
        }
        
        .employee-info strong {
            color: #004d99;
        }

        /* --- è©³æƒ…é é¢ --- */
        .back-button {
            display: inline-block;
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 25px;
            font-size: 16px;
            transition: background 0.3s;
        }

        .back-button:hover {
            background: #5a6268;
        }

        .detail-section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .detail-section h3 {
            color: #004d99;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #004d99;
            font-size: 22px;
        }

        .detail-item, .education-record, .experience-record, .employment-record {
            background: white;
            padding: 15px;
            margin: 12px 0;
            border-radius: 6px;
            border-left: 4px solid;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
        }

        .detail-item { border-left-color: #28a745; } /* åŸºæœ¬è³‡æ–™ï¼šç¶ è‰² */
        .education-record { border-left-color: #fd7e14; } /* å­¸æ­·ï¼šæ©™è‰² */
        .experience-record { border-left-color: #17a2b8; } /* ç¶“é©—ï¼šé’è‰² */
        .employment-record { border-left-color: #6f42c1; } /* å—åƒ±è¨˜éŒ„ï¼šç´«è‰² */

        .detail-item p, .education-record p, .experience-record p, .employment-record p {
            margin: 5px 0;
            color: #444;
        }
        
        .no-data {
            text-align: center;
            color: #999;
            padding: 20px;
            font-style: italic;
            background: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 6px;
        }

        /* --- è©•åˆ†è¡¨å–®æ¨£å¼ --- */
        .evaluation-form, .interview-form {
            padding: 30px;
            border-radius: 10px;
            margin-top: 30px;
            background: #ffffff;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .evaluation-form { border: 3px solid #004d99; }
        .interview-form { border: 3px solid #ff6b35; } /* æœƒé¢è©•åˆ†ç”¨ä¸åŒçš„é¡è‰² */

        .evaluation-form h3, .interview-form h3 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 24px;
            padding-bottom: 10px;
            border-bottom: 2px solid;
        }
        
        .evaluation-form h3 { border-bottom-color: #004d99; }
        .interview-form h3 { border-bottom-color: #ff6b35; }
        
        .evaluator-display {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #555;
            padding: 5px 0;
        }

        .rating-item {
            margin: 25px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 5px solid #004d99;
        }
        
        .interview-form .rating-item {
             border-left-color: #ff6b35;
        }

        .rating-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .rating-title {
            font-weight: bold;
            color: #004d99;
            font-size: 18px;
        }
        
        .interview-form .rating-title {
             color: #ff6b35;
        }

        .rating-range {
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .rating-slider {
            width: 100%;
            margin: 10px 0;
        }

        .rating-value-display {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #28a745; /* è©•åˆ†é¡¯ç¤ºç¶ è‰² */
            margin: 10px 0;
            padding: 5px;
            border: 1px dashed #ccc;
            border-radius: 4px;
        }

        .score-breakdown {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #dee2e6;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 15px;
            font-weight: 500;
        }
        
        .score-item span:first-child {
            color: #555;
        }
        
        .score-item span:last-child {
            color: #004d99;
            font-weight: bold;
        }

        .total-score {
            background: #28a745;
            color: white;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0 0;
            font-size: 28px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.5);
        }

        .submit-button {
            background: #28a745;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            width: 100%;
            margin-top: 20px;
            transition: background 0.3s, transform 0.1s;
        }
        
        /* ä¸åŒçš„æäº¤æŒ‰éˆ•é¡è‰² */
        .evaluation-form .submit-button { background: #004d99; }
        .evaluation-form .submit-button:hover { background: #003a73; }
        .interview-form .submit-button { background: #ff6b35; }
        .interview-form .submit-button:hover { background: #e55e2e; }


        .submit-button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        /* --- æç¤ºè¨Šæ¯ (Toast) --- */
        .alert-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.5s ease-out;
            min-width: 250px;
            text-align: center;
        }

        .alert-success { background: #28a745; border-left: 5px solid #1e7e34; }
        .alert-error { background: #dc3545; border-left: 5px solid #c82333; }
        .alert-warning { background: #ffc107; color: #333; border-left: 5px solid #d39e00; }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .fade-out { animation: slideOut 0.5s ease-in forwards; }

        /* --- éŸ¿æ‡‰å¼è¨­è¨ˆ --- */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .employee-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 24px;
                margin-bottom: 20px;
            }
            
            .detail-section {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ‘¨â€ğŸ’¼å“¡å·¥è©•åˆ†ç³»çµ±</h1>
        <div class="evaluator-info">
            <span>ç•¶å‰è©•æ ¸äººï¼š<span id="currentEvaluatorDisplay"></span></span>
            <button onclick="logout()" class="logout-button">ç™»å‡º</button>
        </div>
        
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹å“¡å·¥å§“åæˆ–ç·¨è™Ÿ..." oninput="filterEmployees()">
        </div>
        
        <div id="employeeList">
            <div class="employee-grid" id="employeeGrid">
                <div class="loading">è¼‰å…¥å“¡å·¥è³‡æ–™ä¸­...</div>
            </div>
        </div>
        
        <div id="employeeDetail" style="display: none;">
            <button class="back-button" onclick="showEmployeeList()">â† è¿”å›å“¡å·¥åˆ—è¡¨</button>
            <div id="basicContent"></div>
        </div>

        <div id="historyDetail" style="display: none;">
            <button class="" onclick="showHistoryList()">æ­·å²è©•åˆ†è¨˜éŒ„</button>
            <div id=""></div>
        </div>
    </div>

    <script>
    const SPREADSHEET_ID = '1znQ2MapAc4fqXJc3SDxoixbrd-b6Xry4auf8vFIcqDc';
    const API_KEY = 'AIzaSyDj2ktQ36AoBSrYxPj_R4USvzvLtfh8Kb0'; 
    const scriptURL = 'https://script.google.com/macros/s/AKfycby46B_BO5E6cbIxYUngBCcT1Las-zSElgx6k1Kf057WH5_T0xrVQvm1IpmEhAtT47jl/exec';
    const SHEETS = {
        BASIC: 'å“¡å·¥è³‡æ–™',
        EDUCATION: 'å­¸æ­·ï¼å°ˆæ¥­è³‡æ ¼',
        EXPERIENCE: 'å·¥ä½œç¶“é©—',
        EMPLOYMENT: 'åº·æ¥­å—åƒ±è¨˜éŒ„',
        RATING_RECORD: 'è€ƒå¯Ÿåœ˜è©•åˆ†ç´€éŒ„',
        INTERVIEW_RECORD: 'æœƒé¢è©•åˆ†ç´€éŒ„',
        RATING: 'è€ƒå¯Ÿåœ˜è©•åˆ†é¸é …',
        INTERVIEW_RATING: 'æœƒé¢è©•åˆ†é¸é …',
        EVALUATORS: 'è©•æ ¸äººåå–®'
    };

    let evaluatorList = [];
    let currentEvaluator = null;
    let allEmployees = [];
    let educationData = [];
    let experienceData = [];
    let employmentData = [];
    let ratingOptions = [];
    let interviewRatingOptions = []; 
    let currentEmployee = null;

    // é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    document.addEventListener('DOMContentLoaded', function() {
        const savedEvaluator = localStorage.getItem("currentEvaluator");
        
        if (!savedEvaluator) {
            // å¦‚æœæœªç™»å…¥ï¼Œè·³è½‰å›ç™»å…¥é 
            window.location.href = "login.html";
            return;
        }
        
        // è¨­ç½®ç•¶å‰è©•æ ¸äºº
        currentEvaluator = savedEvaluator;
        document.getElementById("currentEvaluatorDisplay").textContent = currentEvaluator;
        
        // è¼‰å…¥ç³»çµ±è³‡æ–™
        loadAllData();
    });

    // å¾ Google Sheet åŠ è¼‰è³‡æ–™
    async function loadSheetData(sheetName) {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(sheetName)}?key=${API_KEY}`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            if (!data.values) return [];
            const headers = data.values[0];
            const rows = data.values.slice(1);
            return rows.map(row => {
                const obj = {};
                headers.forEach((header, index) => obj[header] = row[index] || '');
                return obj;
            });
        } catch (error) {
            console.error(`åŠ è¼‰ ${sheetName} å¤±æ•—:`, error);
            return [];
        }
    }

    // åŠ è¼‰æ‰€æœ‰è³‡æ–™
    async function loadAllData() {
        showLoading();
        const [basic, education, experience, employment, ratings, interviewRatings, evaluators] = await Promise.all([
            loadSheetData(SHEETS.BASIC),
            loadSheetData(SHEETS.EDUCATION),
            loadSheetData(SHEETS.EXPERIENCE),
            loadSheetData(SHEETS.EMPLOYMENT),
            loadSheetData(SHEETS.RATING),
            loadSheetData(SHEETS.INTERVIEW_RATING),
            loadSheetData(SHEETS.EVALUATORS)
        ]);

        allEmployees = basic;
        educationData = education;
        experienceData = experience;
        employmentData = employment;
        evaluatorList = evaluators.map(e => e.è©•æ ¸äººå§“å || e.è©•æ ¸äºº);

        // è€ƒå¯Ÿåœ˜è©•åˆ†é¸é …
        ratingOptions = ratings.map(row => ({
            'è©•åˆ†é …ç›®': row['è©•åˆ†é …ç›®'] || 'æœªå‘½å',
            'æœ€ä½åˆ†': parseInt(row['æœ€ä½åˆ†']) || 1,
            'æœ€é«˜åˆ†': parseInt(row['æœ€é«˜åˆ†']) || 5
        }));

        // æœƒé¢è©•åˆ†é¸é …
        interviewRatingOptions = interviewRatings.map(row => ({
            'è©•åˆ†é …ç›®': row['è©•åˆ†é …ç›®'] || 'æœªå‘½å',
            'æœ€ä½åˆ†': parseInt(row['æœ€ä½åˆ†']) || 1,
            'æœ€é«˜åˆ†': parseInt(row['æœ€é«˜åˆ†']) || 5
        }));

        displayEmployees(allEmployees);
        hideLoading();
    }

    // é¡¯ç¤ºå“¡å·¥åˆ—è¡¨
    function displayEmployees(employees) {
        const grid = document.getElementById('employeeGrid');
        if (employees.length === 0) {
            grid.innerHTML = '<div class="error">æ‰¾ä¸åˆ°å“¡å·¥è³‡æ–™</div>';
            return;
        }
        grid.innerHTML = employees.map(emp => `
            <div class="employee-card" onclick="showEmployeeDetail('${emp.å“¡å·¥ç·¨è™Ÿ}')">
                <h3>${emp.å“¡å·¥å§“å || 'ç„¡å§“å'} (${emp.å“¡å·¥ç·¨è™Ÿ || 'ç„¡ç·¨è™Ÿ'})</h3>
                <div class="employee-info">
                    <p><strong>éƒ¨é–€ï¼š</strong>${emp.éƒ¨é–€ || 'æœªå¡«å¯«'}</p>
                    <p><strong>è·ä½ï¼š</strong>${emp.è·ä½ || 'æœªå¡«å¯«'}</p>
                </div>
            </div>
        `).join('');
    }

    // é¡¯ç¤ºå“¡å·¥è©³ç´°è³‡æ–™
    function showEmployeeDetail(employeeId) {
        currentEmployee = allEmployees.find(emp => emp.å“¡å·¥ç·¨è™Ÿ === employeeId);
        if (!currentEmployee) return;

        document.getElementById('employeeList').style.display = 'none';
        document.getElementById('employeeDetail').style.display = 'block';
        displayAllInfo();

        loadHistoryRatings(currentEmployee.å“¡å·¥ç·¨è™Ÿ, currentEvaluator);

        updateTotalScore(ratingOptions, 'rating');
        updateTotalScore(interviewRatingOptions, 'interview');
    }

    // é¡¯ç¤ºæ‰€æœ‰è³‡æ–™
    function displayAllInfo() {
        const content = document.getElementById('basicContent');
        const employee = currentEmployee;

        const educationRecords = educationData.filter(edu => edu.å“¡å·¥ç·¨è™Ÿ === employee.å“¡å·¥ç·¨è™Ÿ);
        const experienceRecords = experienceData.filter(exp => exp.å“¡å·¥ç·¨è™Ÿ === employee.å“¡å·¥ç·¨è™Ÿ);
        const employmentRecords = employmentData.filter(emp => emp.å“¡å·¥ç·¨è™Ÿ === employee.å“¡å·¥ç·¨è™Ÿ);

        content.innerHTML = `
            <div class="detail-section">
                <h3>ğŸ‘¤ åŸºæœ¬è³‡æ–™ - ${employee.å“¡å·¥å§“å}</h3>
                <div class="detail-item">
                    <p><strong>å“¡å·¥ç·¨è™Ÿï¼š</strong>${employee.å“¡å·¥ç·¨è™Ÿ || 'æœªå¡«å¯«'}</p>
                    <p><strong>å¹´é½¡ï¼š</strong>${employee.å¹´é½¡ || 'æœªå¡«å¯«'}</p>
                    <p><strong>å©šå§»ç‹€æ³ï¼š</strong>${employee.å©šå§»ç‹€æ³ || 'æœªå¡«å¯«'}</p>
                    <p><strong>å­å¥³æ•¸ç›®ï¼š</strong>${employee.å­å¥³æ•¸ç›® || '0'}</p>
                    <p><strong>è·ä½ï¼š</strong>${employee.è·ä½ || 'æœªå¡«å¯«'}</p>
                    <p><strong>éƒ¨é–€/åˆ†å€ï¼š</strong>${employee.éƒ¨é–€ || 'æœªå¡«å¯«'}</p>
                    <p><strong>åˆ°è·æ—¥æœŸï¼š</strong>${employee.åˆ°è·æ—¥æœŸ || 'æœªå¡«å¯«'}</p>
                    <p><strong>ç¸¾æ•ˆè©•ä¼°ç­‰ç´š2023ï¼š</strong>${employee.ç¸¾æ•ˆè©•ä¼°ç­‰ç´š2023 || 'æœªå¡«å¯«'}</p>
                    <p><strong>ç¸¾æ•ˆè©•ä¼°ç­‰ç´š2024ï¼š</strong>${employee.ç¸¾æ•ˆè©•ä¼°ç­‰ç´š2024 || 'æœªå¡«å¯«'}</p>
                </div>
            </div>

            <div class="detail-section">
                <h3>ğŸ“ å­¸æ­·ï¼å°ˆæ¥­è³‡æ ¼</h3>
                ${educationRecords.length > 0 ? educationRecords.map(record => `
                    <div class="education-record">
                        <p><strong>æœŸé–“ï¼š</strong>${record.ç”± || ''} - ${record.è‡³ || ''}</p>
                        <p><strong>å­¸é™¢åç¨±ï¼š</strong>${record.å­¸é™¢åç¨± || ''}</p>
                        <p><strong>æ‰€ç²è­‰æ›¸/è³‡æ ¼ï¼š</strong>${record.æ‰€ç²è­‰æ›¸è³‡æ ¼ || ''}</p>
                    </div>
                `).join('') : '<div class="no-data">æ²’æœ‰å­¸æ­·è³‡æ ¼è¨˜éŒ„</div>'}
            </div>

            <div class="detail-section">
                <h3>ğŸ¢ å·¥ä½œç¶“é©—</h3>
                ${experienceRecords.length > 0 ? experienceRecords.map(record => `
                    <div class="experience-record">
                        <p><strong>æœŸé–“ï¼š</strong>${record.ç”± || ''} - ${record.è‡³ || ''}</p>
                        <p><strong>å…¬å¸åç¨±ï¼š</strong>${record.å…¬å¸åç¨± || ''}</p>
                        <p><strong>é›¢è·æ™‚è·ä½ï¼š</strong>${record.é›¢è·æ™‚è·ä½ || ''}</p>
                        <p><strong>å…¥è·å‰ç¸½å¹´è³‡ï¼š</strong>${record.å…¥è·å‰ç¸½å¹´è³‡ || ''}</p>
                    </div>
                `).join('') : '<div class="no-data">æ²’æœ‰å·¥ä½œç¶“é©—è¨˜éŒ„</div>'}
            </div>

            <div class="detail-section">
                <h3>ğŸ“‹ åº·æ¥­å—åƒ±è¨˜éŒ„</h3>
                ${employmentRecords.length > 0 ? employmentRecords.map(record => `
                    <div class="employment-record">
                        <p><strong>æœŸé–“ï¼š</strong>${record.ç”± || ''} - ${record.è‡³ || ''}</p>
                        <p><strong>åˆ†å€ï¼š</strong>${record.åˆ†å€ || ''}</p>
                        <p><strong>å¤§å»ˆï¼š</strong>${record.å¤§å»ˆ || ''}</p>
                        <p><strong>è·ä½ï¼š</strong>${record.è·ä½ || ''}</p>
                        <p><strong>å¹´è³‡ï¼š</strong>${record.å¹´è³‡ || ''}</p>
                    </div>
                `).join('') : '<div class="no-data">æ²’æœ‰å—åƒ±è¨˜éŒ„</div>'}
            </div>

            <div class="detail-section" id="historyRatingsSection">
                <h3>ğŸ•°ï¸ æ­·å²è©•åˆ†è¨˜éŒ„ </h3>
                <div id="historyRatingsContainer">
                    <div class="no-data">æ­£åœ¨è¼‰å…¥æ­·å²è©•åˆ†...</div>
                </div>
            </div>

            <!-- è€ƒå¯Ÿåœ˜è©•åˆ†è¡¨å–® -->
            <div class="evaluation-form">
                <h3>ğŸ“ è€ƒå¯Ÿåœ˜æ•´é«”è©•åˆ†</h3>
                <div class="evaluator-display">è©•æ ¸äººï¼š${currentEvaluator}</div>
                <div id="ratingItemsContainer">${generateRatingItems(ratingOptions, 'rating')}</div>
                <div class="score-breakdown" id="ratingScoreBreakdown">${generateScoreBreakdown(ratingOptions, 'rating')}</div>
                <div class="total-score" id="ratingTotalScore">ç¸½åˆ†: 0 / ${calculateMaxScore(ratingOptions)}</div>
                <button class="submit-button" onclick="submitEvaluation('è€ƒå¯Ÿåœ˜æ•´é«”è©•åˆ†', ratingOptions, 'rating')">æäº¤è€ƒå¯Ÿåœ˜è©•åˆ†</button>
            </div>

            <!-- æœƒé¢è©•åˆ†è¡¨å–® -->
            <div class="interview-form">
                <h3>ğŸ“ æœƒé¢è©•åˆ†</h3>
                <div class="evaluator-display">è©•æ ¸äººï¼š${currentEvaluator}</div>
                <div id="interviewRatingItemsContainer">${generateRatingItems(interviewRatingOptions, 'interview')}</div>
                <div class="score-breakdown" id="interviewScoreBreakdown">${generateScoreBreakdown(interviewRatingOptions, 'interview')}</div>
                <div class="total-score" id="interviewTotalScore">ç¸½åˆ†: 0 / ${calculateMaxScore(interviewRatingOptions)}</div>
                <button class="submit-button" onclick="submitEvaluation('æœƒé¢è©•åˆ†', interviewRatingOptions, 'interview')">æäº¤æœƒé¢è©•åˆ†</button>
            </div>
        `;

        // ç¶å®šè©•åˆ†æ»‘æ¡¿äº‹ä»¶
        setupRatingSliders(ratingOptions, 'rating');
        setupRatingSliders(interviewRatingOptions, 'interview');
    }

    // ç”Ÿæˆè©•åˆ†æ»‘æ¡¿
    function generateRatingItems(options, prefix) {
        return options.map((option, index) => `
            <div class="rating-item">
                <div class="rating-header"><span class="rating-title">${option.è©•åˆ†é …ç›®}</span></div>
                <div class="rating-range">è©•åˆ†ç¯„åœ: ${option.æœ€ä½åˆ†} - ${option.æœ€é«˜åˆ†}åˆ†</div>
                <input type="range" class="rating-slider" id="${prefix}-rating-${index}" min="${option.æœ€ä½åˆ†}" max="${option.æœ€é«˜åˆ†}" value="3" step="1">
                <div class="rating-value-display" id="${prefix}-value-${index}">3</div>
            </div>
        `).join('');
    }

    // ç”Ÿæˆåˆ†æ•¸æ˜ç´°
    function generateScoreBreakdown(options, prefix) {
        return options.map((option, index) => `
            <div class="score-item" id="${prefix}-breakdown-${index}">
                <span>${option.è©•åˆ†é …ç›®}:</span>
                <span>0 åˆ†</span>
            </div>
        `).join('');
    }

    // è¨ˆç®—æœ€å¤§å¯èƒ½åˆ†æ•¸
    function calculateMaxScore(options) {
        return options.reduce((total, option) => total + option.æœ€é«˜åˆ†, 0);
    }

    // è¨­ç½®è©•åˆ†æ»‘æ¡¿äº‹ä»¶
    function setupRatingSliders(options, prefix) {
        options.forEach((option, index) => {
            const slider = document.getElementById(`${prefix}-rating-${index}`);
            const valueDisplay = document.getElementById(`${prefix}-value-${index}`);
            if (slider && valueDisplay) {
                slider.addEventListener('input', () => {
                    valueDisplay.textContent = slider.value;
                    updateTotalScore(options, prefix);
                });
            }
        });
    }

    // æ›´æ–°ç¸½åˆ†
    function updateTotalScore(options, prefix) {
        let totalScore = 0;
        options.forEach((option, index) => {
            const slider = document.getElementById(`${prefix}-rating-${index}`);
            const breakdown = document.getElementById(`${prefix}-breakdown-${index}`);
            if (slider && breakdown) {
                const score = parseInt(slider.value);
                totalScore += score;
                breakdown.innerHTML = `<span>${option.è©•åˆ†é …ç›®}:</span><span>${score} åˆ†</span>`;
            }
        });
        document.getElementById(`${prefix}TotalScore`).textContent = `ç¸½åˆ†: ${totalScore} / ${calculateMaxScore(options)}`;
    }

    // æäº¤è©•åˆ†ï¼ˆä¿®æ­£ç‰ˆæœ¬ï¼‰
    async function submitEvaluation(sheetName, options, prefix) {
        if (!currentEvaluator) {
            alert('è«‹å…ˆç™»å…¥');
            window.location.href = "login.html";
            return;
        }

        if (!currentEmployee) {
            alert('è«‹å…ˆé¸æ“‡å“¡å·¥');
            return;
        }

        const evaluationData = {
            'å“¡å·¥ç·¨è™Ÿ': currentEmployee.å“¡å·¥ç·¨è™Ÿ,
            'å“¡å·¥å§“å': currentEmployee.å“¡å·¥å§“å,
            'è©•æ ¸äºº': currentEvaluator,
            'è©•åˆ†æ—¥æœŸ': new Date().toLocaleDateString('zh-TW'),
            'ç¸½åˆ†': 0
        };

        let totalScore = 0;
        options.forEach((option, index) => {
            const slider = document.getElementById(`${prefix}-rating-${index}`);
            if (slider) {
                const score = parseInt(slider.value);
                evaluationData[option.è©•åˆ†é …ç›®] = score;
                totalScore += score;
            }
        });
        evaluationData['ç¸½åˆ†'] = totalScore;

        console.log('æäº¤è©•åˆ†æ•¸æ“š:', evaluationData);

        try {
            const buttons = document.querySelectorAll(`button[onclick*="submitEvaluation('${sheetName}'"]`);
            const button = buttons[0];
            
            button.disabled = true;
            button.textContent = 'æäº¤ä¸­...';

            const scriptURL = 'https://script.google.com/macros/s/AKfycby46B_BO5E6cbIxYUngBCcT1Las-zSElgx6k1Kf057WH5_T0xrVQvm1IpmEhAtT47jl/exec';
            
            await fetch(scriptURL, {
                method: "POST",
                
                headers: { 
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    action: "saveEvaluation",
                    sheetName: sheetName,
                    data: evaluationData
                })
            });

            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            const successMsg = document.createElement('div');
            successMsg.className = 'success';
            alert(`${sheetName}å·²æˆåŠŸæäº¤ï¼`);
            button.parentElement.prepend(successMsg);

            setTimeout(() => {
                successMsg.remove();
                button.disabled = false;
                button.textContent = `æäº¤${sheetName}`;
            }, 2000);

        } catch (error) {
            console.error("æäº¤è©•åˆ†å¤±æ•—:", error);
            alert("æäº¤è©•åˆ†å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
            
            const buttons = document.querySelectorAll(`button[onclick*="submitEvaluation('${sheetName}'"]`);
            const button = buttons[0];
            button.disabled = false;
            button.textContent = `æäº¤${sheetName}`;
        }
    }

    async function loadHistoryRatings(employeeId, evaluator) {
        const container = document.getElementById('historyRatingsContainer');
        container.innerHTML = '<div class="no-data">æ­£åœ¨è¼‰å…¥æ­·å²è©•åˆ†...</div>';

        try {
            // ä½¿ç”¨ GET è«‹æ±‚ï¼ŒAction=getRatings
            const url = `${scriptURL}?action=getRatings&employeeId=${employeeId}&evaluator=${evaluator}`;
            
            const response = await fetch(url);
            const result = await response.json(); 

            if (!result.success) {
                container.innerHTML = `<div class="no-data" style="color: #c0392b;">è¼‰å…¥æ­·å²å¤±æ•—: ${result.message}</div>`;
                return;
            }

            const allHistory = result.data;
            
            if (!allHistory || (allHistory.tour.length === 0 && allHistory.interview.length === 0)) {
                container.innerHTML = '<div class="no-data">ç„¡ç›¸é—œæ­·å²è©•åˆ†è¨˜éŒ„ã€‚</div>';
                return;
            }

            // é¡¯ç¤ºæ­·å²æ•¸æ“š
            container.innerHTML = `
                ${renderHistorySection(allHistory.tour, 'è€ƒå¯Ÿåœ˜è©•åˆ†ç´€éŒ„', '#004d99')}
                ${renderHistorySection(allHistory.interview, 'æœƒé¢è©•åˆ†ç´€éŒ„', '#ff6b35')}
            `;
            
        } catch (error) {
            console.error("è¼‰å…¥æ­·å²è©•åˆ†å¤±æ•—:", error);
            container.innerHTML = `<div class="no-data" style="color: #e74c3c;">ç¶²çµ¡æˆ–è…³æœ¬éŒ¯èª¤ï¼Œç„¡æ³•è¼‰å…¥æ­·å²è¨˜éŒ„ã€‚</div>`;
        }
    }

    // æ¸²æŸ“æ­·å²è¨˜éŒ„çš„è¼”åŠ©å‡½æ•¸
    function renderHistorySection(records, title, color) {
        if (records.length === 0) {
            return ''; // å¦‚æœæ²’æœ‰è¨˜éŒ„å‰‡ä¸é¡¯ç¤ºå€å¡Š
        }
        
        // ç²å–æœ€æ–°ä¸€æ¢è¨˜éŒ„ (å‡è¨­ App Script å·²ç¶“æ’åºæˆ–æœ€å¾Œä¸€æ¢å°±æ˜¯æœ€æ–°)
        const latestRecord = records[records.length - 1]; 
        
        let detailHtml = Object.keys(latestRecord).map(key => {
            // æ’é™¤åŸºç¤æ¬„ä½ï¼Œåªé¡¯ç¤ºè©•åˆ†ç´°ç¯€
            if (!['å“¡å·¥ç·¨è™Ÿ', 'å“¡å·¥å§“å', 'è©•æ ¸äºº', 'ç¸½åˆ†', 'è©•åˆ†æ—¥æœŸ'].includes(key) && latestRecord[key] !== undefined && latestRecord[key] !== '') {
                return `<p style="margin-left: 10px; font-size: 14px;">${key}: **${latestRecord[key]}** åˆ†</p>`;
            }
            return '';
        }).join('');

        return `
            <div style="border: 1px solid #ddd; border-left: 5px solid ${color}; padding: 15px; margin-top: 15px; border-radius: 5px; background: #fff;">
                <h4 style="margin-top: 0; color: ${color}; font-size: 18px;">${title} (æœ€æ–°è¨˜éŒ„)</h4>
                <p><strong>è©•åˆ†æ—¥æœŸï¼š</strong>${latestRecord['è©•åˆ†æ—¥æœŸ'] || 'N/A'}</p>
                <p><strong>ç¸½åˆ†ï¼š</strong><span style="font-size: 1.2em; font-weight: bold; color: #28a745;">${latestRecord['ç¸½åˆ†'] || 'N/A'}</span></p>
                <details style="margin-top: 10px;">
                    <summary style="font-weight: bold; cursor: pointer; color: #555;">é»æ“ŠæŸ¥çœ‹è©•åˆ†ç´°ç¯€</summary>
                    <div style="padding-top: 5px;">${detailHtml}</div>
                </details>
                <p style="color: #dc3545; font-weight: bold; margin-top: 10px; font-size: 14px;">
                    *æ‚¨å†æ¬¡æäº¤è©•åˆ†ï¼Œå°‡æœƒ**è¦†è“‹**æ­¤æœ€æ–°è¨˜éŒ„ã€‚
                </p>
            </div>
        `;
    }

    // è¿”å›å“¡å·¥åˆ—è¡¨
    function showEmployeeList() {
        document.getElementById('employeeDetail').style.display = 'none';
        document.getElementById('employeeList').style.display = 'block';
        currentEmployee = null;
    }

    // æœå°‹éæ¿¾
    function filterEmployees() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const filtered = allEmployees.filter(emp =>
            (emp.å“¡å·¥å§“å && emp.å“¡å·¥å§“å.toLowerCase().includes(searchTerm)) ||
            (emp.å“¡å·¥ç·¨è™Ÿ && emp.å“¡å·¥ç·¨è™Ÿ.toLowerCase().includes(searchTerm))
        );
        displayEmployees(filtered);
    }

    function showLoading() { 
        document.getElementById('employeeGrid').innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>'; 
    }
    
    function hideLoading() {}
    
    function showError(message) { 
        document.getElementById('employeeGrid').innerHTML = `<div class="error">${message}</div>`; 
    }

    // ç™»å‡ºåŠŸèƒ½
    function logout() {
        localStorage.removeItem("currentEvaluator");
        window.location.href = "login.html";
    }
    </script>
</body>
</html>