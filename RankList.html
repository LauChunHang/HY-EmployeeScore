<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<title>å“¡å·¥è©•åˆ†æ’è¡Œæ¦œ</title>

<script src="https://cdn.tailwindcss.com"></script>

<style>
.rank-item {
    display: flex;
    justify-content: space-between;
    padding: 14px;
    margin-bottom: 12px;
    border-radius: 12px;
    background: white;
    border: 1px solid #e2e8f0;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}
.rank-no {
    font-size: 20px;
    font-weight: bold;
    color: #4f46e5;
}
.emp-score {
    text-align: right;
    font-size: 18px;
    font-weight: bold;
    color: #2563eb;
}
.detail {
    font-size: 12px;
    color: #666;
}
</style>
</head>

<body class="bg-gray-100">

<!-- é ‚éƒ¨å°è¦½åˆ— -->
<header class="sticky top-0 z-10 bg-white shadow-md border-b border-gray-200">
  <div class="container mx-auto px-4 h-20 flex items-center justify-between">

    <div class="flex items-center gap-3">
      <button
        onclick="showEmployeeList()"
        class="h-10 px-4 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg shadow flex items-center">
        è¿”å›åˆ—è¡¨
      </button>

      <img src="HongYipLogo.png" class="w-14 h-14 object-contain">
      <h1 class="text-lg font-bold text-indigo-700">å“¡å·¥è©•åˆ†ç³»çµ±</h1>
    </div>

   <div class="flex items-center max-w-[300px] overflow-hidden">
  <span class="text-gray-700 text-sm whitespace-nowrap mr-1">ç•¶å‰è©•æ ¸äººï¼š</span>
  <span
    id="currentEvaluatorDisplay"
    class="font-bold text-indigo-600 text-sm whitespace-nowrap overflow-hidden text-ellipsis">
  </span>
</div>


    <div class="flex gap-3 items-center">
      <button onclick="Ranklist()" class="h-10 px-4 bg-blue-500 hover:bg-blue-600 text-white rounded-lg shadow">
        æ’è¡Œæ¦œ
      </button>
      <button onclick="logout()" class="h-10 px-4 bg-red-500 hover:bg-red-600 text-white rounded-lg shadow">
        ç™»å‡º
      </button>
    </div>

  </div>
</header>

<!-- ä¸»å…§å®¹ -->
<main class="container mx-auto py-8 px-4">

    <!-- è©•æ ¸äºº + æŒ‰éˆ• -->
   

    <h2 class="text-2xl font-bold mb-4">ğŸ† å“¡å·¥è©•åˆ†æ’è¡Œæ¦œ</h2>

    <div id="rankList">è¼‰å…¥ä¸­...</div>

</main>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycby46B_BO5E6cbIxYUngBCcT1Las-zSElgx6k1Kf057WH5_T0xrVQvm1IpmEhAtT47jl/exec";

// â­ è¿”å› index.html
function showEmployeeList() {
    window.location.href = "index.html";
}

// â­ ç™»å‡º
function logout() {
    localStorage.removeItem("currentEvaluator");
    window.location.href = "login.html";
}

// â­ å‰å¾€æ’è¡Œæ¦œï¼ˆè‡ªå·±é é¢ï¼Œä¸éä½ æœ‰å¯èƒ½ä¹‹å¾Œæœƒæ”¹ï¼‰
function Ranklist() {
    window.location.href = "RankList.html";
}

// â­ è®€å–å“¡å·¥å§“åå°ç…§è¡¨
async function loadEmployeeMap() {
    const res = await fetch(`${scriptURL}?action=getEmployeeList`);
    const json = await res.json();

    if (!json.success) return {};

    const map = {};
    json.data.forEach(emp => {
        map[emp.å“¡å·¥ç·¨è™Ÿ] = emp.å“¡å·¥å§“å;
    });
    return map;
}

// â­ ä¸»æµç¨‹
document.addEventListener("DOMContentLoaded", async () => {
    const evaluator = localStorage.getItem("currentEvaluator");

    if (!evaluator) {
        alert("è«‹é‡æ–°ç™»å…¥");
        return (window.location.href = "login.html");
    }

    document.getElementById("currentEvaluatorDisplay").textContent = evaluator;

    window.employeeMap = await loadEmployeeMap();
    loadRankList(evaluator);
});

// â­ å–å¾—æ‰€æœ‰è©•åˆ†
async function loadRankList(evaluator) {
    const url = `${scriptURL}?action=getAllEvaluatorRatings&evaluator=${encodeURIComponent(evaluator)}`;

    try {
        const response = await fetch(url);
        const json = await response.json();

        if (!json.success) {
            document.getElementById("rankList").innerHTML =
                `<div class="error">è®€å–å¤±æ•—ï¼š${json.message}</div>`;
            return;
        }

        const list = json.data;

        const ranked = list.map(item => {
            const id = item.å“¡å·¥ç·¨è™Ÿ;

            return {
                å“¡å·¥ç·¨è™Ÿ: id,
                å“¡å·¥å§“å: window.employeeMap[id] || "(æœªæœ‰å§“å)",
                tourTotal: item.tourTotal || 0,
                interviewTotal: item.interviewTotal || 0,
                total: (item.tourTotal || 0) + (item.interviewTotal || 0)
            };
        }).sort((a, b) => b.total - a.total);

        renderRankList(ranked);

    } catch (err) {
        document.getElementById("rankList").innerHTML =
            `<div class="error">ç™¼ç”ŸéŒ¯èª¤ï¼š${err.message}</div>`;
    }
}

// â­ æ¸²æŸ“æ’è¡Œæ¦œ
function renderRankList(data) {
    const container = document.getElementById("rankList");

    container.innerHTML = data.map((emp, index) => `
        <div class="rank-item cursor-pointer hover:bg-indigo-50 transition"
             onclick="showEmployeeDetail('${emp.å“¡å·¥ç·¨è™Ÿ}')">

            <div class="rank-no">#${index + 1}</div>

            <div>
                <strong>${emp.å“¡å·¥å§“å}</strong>
                <div class="text-sm text-gray-500">(${emp.å“¡å·¥ç·¨è™Ÿ})</div>
            </div>

            <div class="emp-score">
                ${emp.total} åˆ†
                <div class="detail">
                    è€ƒå¯Ÿåœ˜ï¼š${emp.tourTotal} ï¼ æœƒé¢ï¼š${emp.interviewTotal}
                </div>
            </div>
        </div>
    `).join("");
}

function goToEmployee(empId) {
    // è·³å»è©•åˆ†ä¸»é ï¼Œå¸¶å“¡å·¥ç·¨è™Ÿ
    window.location.href = `index.html?employeeId=${encodeURIComponent(empId)}`;
}


</script>

</body>
</html>
