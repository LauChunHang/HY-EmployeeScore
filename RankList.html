<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å“¡å·¥è©•åˆ†æ’è¡Œæ¦œ</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body {
    font-family: 'Inter', sans-serif;
}
.rank-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px;
    margin-bottom: 12px;
    border-radius: 12px;
    background: white;
    border: 1px solid #e2e8f0;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    cursor: pointer;
    transition: background-color 0.2s, transform 0.1s;
}
.rank-item:hover {
    background-color: #f0f4ff;
    transform: translateY(-1px);
}
.rank-no {
    font-size: 20px;
    font-weight: bold;
    color: #4f46e5;
    min-width: 40px; 
    text-align: center;
}
.emp-score {
    text-align: right;
    font-size: 18px;
    font-weight: bold;
    color: #2563eb;
}
.detail {
    font-size: 12px;
    color: #666;
}
</style>
</head>

<body class="bg-gray-100">

<!-- é ‚éƒ¨å°è¦½åˆ— -->
<header class="sticky top-0 z-10 bg-white shadow-md border-b border-gray-200">
  <div class="container mx-auto px-4 h-20 flex items-center justify-between">

    <div class="flex items-center gap-3">
      <button
        onclick="showEmployeeList()"
        class="h-10 px-4 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg shadow flex items-center text-sm">
        è¿”å›åˆ—è¡¨
      </button>

      <img src="HongYipLogo.png" class="w-14 h-14 object-contain">
      <h1 class="text-lg font-bold text-indigo-700">å“¡å·¥è©•åˆ†ç³»çµ±</h1>
    </div>

   


   <div class="flex gap-3 items-center flex-shrink-0">
      <button onclick="Ranklist()" 
              class="h-10 px-4 bg-blue-500 hover:bg-blue-600 text-white rounded-lg shadow text-sm">
        æ’è¡Œæ¦œ
      </button>
      <button onclick="logout()" 
              class="h-10 px-4 bg-red-500 hover:bg-red-600 text-white rounded-lg shadow text-sm">
        ç™»å‡º
      </button>
    </div>

  </div>
</header>

<!-- ä¸»å…§å®¹ -->
 
<main class="container mx-auto py-8 px-4 max-w-3xl">

     <div class="flex items-center max-w-[300px] overflow-hidden">
  <span class="text-gray-700 text-sm whitespace-nowrap mr-1">ç•¶å‰è©•æ ¸äººï¼š</span>
  <span
    id="currentEvaluatorDisplay"
    class="font-bold text-indigo-600 text-sm whitespace-nowrap overflow-hidden text-ellipsis">
  </span>
</div>

  <h2 class="text-3xl font-bold mb-6 text-gray-800 border-b pb-2">ğŸ† å“¡å·¥è©•åˆ†æ’è¡Œæ¦œ</h2>

  <div id="rankList" class="text-center text-gray-500 py-10">è¼‰å…¥ä¸­...</div>

</main>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycby46B_BO5E6cbIxYUngBCcT1Las-zSElgx6k1Kf057WH5_T0xrVQvm1IpmEhAtT47jl/exec";

// è¿”å›ä¸»å“¡å·¥åˆ—è¡¨
function showEmployeeList() {
    window.location.href = "index.html";
}

// ç™»å‡º
function logout() {
    // å½ˆå‡ºç¢ºèªå°è©±æ¡†
    const confirmed = confirm("æ‚¨ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ\nç™»å‡ºå¾Œå°‡è¿”å›ç™»å…¥é é¢ã€‚");

    if (confirmed) {
        // ç”¨æˆ¶é»æ“Šã€Œç¢ºå®šã€
        showCustomMessage('å·²ç™»å‡º', 'info');
        localStorage.removeItem("currentEvaluator");
        
        setTimeout(() => {
            window.location.href = "login.html";
        }, 500);
    }
    // å¦‚æœç”¨æˆ¶é»æ“Šã€Œå–æ¶ˆã€ï¼Œä»€éº¼éƒ½ä¸åšï¼Œç›´æ¥è¿”å›
}

// å·²åœ¨æ­¤é ï¼Œä¸éœ€è·³è½‰
function Ranklist() {
    // å¯ç•™ç©ºæˆ–æ»¾å‹•åˆ°é ‚éƒ¨
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// é—œéµï¼šé»æ“Šå“¡å·¥ç›´æ¥è·³åˆ°è©•åˆ†è©³ç´°é ï¼ˆä½¿ç”¨ hashï¼‰
// æ”¹æˆä½¿ç”¨ hash è·³è½‰
function goToEmployee(empId) {
    window.location.href = `index.html#detail-${empId}`;
}

// è®€å–å“¡å·¥å§“åå°ç…§è¡¨
async function loadEmployeeMap() {
    try {
        const res = await fetch(`${scriptURL}?action=getEmployeeList`);
        const json = await res.json();
        if (!json.success) return {};
        const map = {};
        json.data.forEach(emp => {
            map[emp.å“¡å·¥ç·¨è™Ÿ] = emp.å“¡å·¥å§“å;
        });
        return map;
    } catch (err) {
        console.error("è®€å–å“¡å·¥åˆ—è¡¨å¤±æ•—:", err);
        return {};
    }
}

// ä¸»æµç¨‹
document.addEventListener("DOMContentLoaded", async () => {
    const evaluator = localStorage.getItem("currentEvaluator");
    if (!evaluator) {
        console.error("æœªç™»å…¥ï¼Œè·³è½‰ç™»å…¥é ");
        window.location.href = "login.html";
        return;
    }

    document.getElementById("currentEvaluatorDisplay").textContent = evaluator;

    window.employeeMap = await loadEmployeeMap();
    loadRankList(evaluator);
});

// å–å¾—æ’è¡Œæ•¸æ“š
async function loadRankList(evaluator) {
    const url = `${scriptURL}?action=getAllEvaluatorRatings&evaluator=${encodeURIComponent(evaluator)}`;
    const container = document.getElementById("rankList");

    try {
        const response = await fetch(url);
        const json = await response.json();

        if (!json.success || !json.data || json.data.length === 0) {
            container.innerHTML = `
                <div class="p-10 text-center bg-white rounded-lg shadow border">
                    <p class="text-gray-500 text-lg">å°šæœªæœ‰ä»»ä½•è©•åˆ†è¨˜éŒ„</p>
                </div>`;
            return;
        }

        const list = json.data;

        const ranked = list.map(item => {
            const id = item.å“¡å·¥ç·¨è™Ÿ;
            return {
                å“¡å·¥ç·¨è™Ÿ: id,
                å“¡å·¥å§“å: window.employeeMap[id] || "(æœªæœ‰å§“å)",
                tourTotal: item.tourTotal || 0,
                interviewTotal: item.interviewTotal || 0,
                total: (item.tourTotal || 0) + (item.interviewTotal || 0)
            };
        }).sort((a, b) => b.total - a.total);

        renderRankList(ranked);

    } catch (err) {
        container.innerHTML = `
            <div class="p-10 text-center bg-white rounded-lg shadow border text-red-600">
                ç„¡æ³•è¼‰å…¥æ’è¡Œæ¦œ<br><small>${err.message}</small>
            </div>`;
    }
}

// æ¸²æŸ“æ’è¡Œæ¦œï¼ˆé»æ“Šè·³è½‰åˆ°è©³ç´°è©•åˆ†ï¼‰
function renderRankList(data) {
    const container = document.getElementById("rankList");
    if (data.length === 0) {
        container.innerHTML = `<p class="text-center text-gray-500 py-10">ç„¡è©•åˆ†æ•¸æ“š</p>`;
        return;
    }

    container.innerHTML = data.map((emp, index) => `
        <div class="rank-item" onclick="goToEmployee('${emp.å“¡å·¥ç·¨è™Ÿ}')">
            <div class="rank-no">#${index + 1}</div>
            <div class="flex-1">
                <div class="font-semibold text-lg">${emp.å“¡å·¥å§“å}</div>
                <div class="text-sm text-gray-500">å“¡å·¥ç·¨è™Ÿï¼š${emp.å“¡å·¥ç·¨è™Ÿ}</div>
            </div>
            <div class="emp-score">
                <div class="text-2xl">${emp.total} åˆ†</div>
                <div class="detail">
                    è€ƒå¯Ÿåœ˜ï¼š${emp.tourTotal} åˆ† ï½œ æœƒé¢ï¼š${emp.interviewTotal} åˆ†
                </div>
            </div>
        </div>
    `).join('');
}
</script>

</body>
</html>