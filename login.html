<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>登入評核系統</title>
  <link rel="stylesheet" href="login.css">
</head>
<body>
  <div class="login-container">
    <h2>登入評核系統</h2>
    <select id="evaluatorSelect">
      <option value="" disabled selected>請選擇評核人</option>
    </select>
    <input 
      type="password" 
      id="passwordInput" 
      placeholder="請輸入密碼"
      onkeydown="handleEnterKey(event)"
    >

    <button onclick="login()">登入</button>
    <div id="loginError" class="error" style="color: red; margin-top: 10px;"></div>
    <br>
  </div>

  <script>
    const SPREADSHEET_ID = '1ouVpIPhmsNShN7SYkMGBkd0W6bO9fiKf4WBlzmCU9p4';
    const API_KEY = 'AIzaSyDj2ktQ36AoBSrYxPj_R4USvzvLtfh8Kb0'; 
    const EVALUATORS_SHEET = '評核人名單';
    const COMMON_PASSWORD = "123456";
    let evaluatorList = [];

    // 從 Google Sheets 讀取評核人名單
    async function loadEvaluators() {
      try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(EVALUATORS_SHEET)}?key=${API_KEY}`;
       
        const response = await fetch(url);
        const data = await response.json();
       
        if (data.values && data.values.length > 1) {
          evaluatorList = data.values.slice(1).map(row => row[0]); 
          
          const select = document.getElementById('evaluatorSelect');
          evaluatorList.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            select.appendChild(option);
          });
        } else {
          document.getElementById('loginError').textContent = '名單為空或格式錯誤';
        }
      } catch (error) {
        console.error('載入評核人名單失敗:', error);
        document.getElementById('loginError').textContent = '無法載入評核人名單';
      }
    }

    // 修正後的單一登入函數
    function login() {
      const select = document.getElementById('evaluatorSelect');
      const passwordInput = document.getElementById('passwordInput');
      const name = select.value.trim();
      const password = passwordInput.value.trim();
      const errorDiv = document.getElementById('loginError');

      errorDiv.textContent = '';

      // 1. 檢查是否選擇了評核人
      if (!name) {
        errorDiv.textContent = '請選擇評核人';
        return;
      }

      // 2. 檢查是否輸入了密碼
      if (!password) {
        errorDiv.textContent = '請輸入密碼';
        return;
      }

      // 3. 檢查密碼是否正確
      if (password !== COMMON_PASSWORD) {
        errorDiv.textContent = '密碼錯誤';
        return;
      }

      // 4. 檢查名單是否已載入
      if (evaluatorList.length === 0) {
        errorDiv.textContent = '名單尚未載入，請稍後再試';
        return;
      }

      // 5. 驗證身份並執行登入
      const actualName = evaluatorList.find(evaluator =>
        evaluator.toLowerCase() === name.toLowerCase()
      );

      if (actualName) {
        localStorage.setItem("currentEvaluator", actualName);
        localStorage.setItem("isLoggedIn", "true");
        window.location.href = "index.html";
      } else {
        errorDiv.textContent = '姓名不存在，無法登入';
      }
    }

    // 處理 Enter 鍵
    function handleEnterKey(event) {
      if (event.key === 'Enter') {
        login();
      }
    }

    // 頁面載入時讀取名單
    document.addEventListener('DOMContentLoaded', loadEvaluators);
  </script>
</body>
</html>